<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BuildingEventHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TofuNomics</a> &gt; <a href="index.source.html" class="el_package">org.tofu.tofunomics.events.handlers</a> &gt; <span class="el_source">BuildingEventHandler.java</span></div><h1>BuildingEventHandler.java</h1><pre class="source lang-java linenums">package org.tofu.tofunomics.events.handlers;

import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.Player;
import org.bukkit.event.block.BlockPlaceEvent;
import org.bukkit.inventory.ItemStack;
import org.tofu.tofunomics.config.ConfigManager;
import org.tofu.tofunomics.dao.PlayerDAO;
import org.tofu.tofunomics.events.AsyncEventUpdater;
import org.tofu.tofunomics.jobs.JobManager;
import org.tofu.tofunomics.models.PlayerJob;

import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

/**
 * 建築イベントハンドラ
 * 建築家のブロック設置処理を管理
 */
public class BuildingEventHandler {
    
    private final ConfigManager configManager;
    private final PlayerDAO playerDAO;
    private final JobManager jobManager;
    private final AsyncEventUpdater asyncUpdater;
    
    // 建築材料による報酬
    private final Map&lt;Material, BuildingReward&gt; buildingRewards;
    
    // 建築家専用装飾ブロック
    private final Set&lt;Material&gt; decorativeBlocks;
    
    // 建築プロジェクトの追跡
    private final Map&lt;String, BuildingProject&gt; activeProjects;
    
    public BuildingEventHandler(ConfigManager configManager, PlayerDAO playerDAO,
<span class="nc" id="L42">                               JobManager jobManager, AsyncEventUpdater asyncUpdater) {</span>
<span class="nc" id="L43">        this.configManager = configManager;</span>
<span class="nc" id="L44">        this.playerDAO = playerDAO;</span>
<span class="nc" id="L45">        this.jobManager = jobManager;</span>
<span class="nc" id="L46">        this.asyncUpdater = asyncUpdater;</span>
<span class="nc" id="L47">        this.buildingRewards = new HashMap&lt;&gt;();</span>
<span class="nc" id="L48">        this.decorativeBlocks = new HashSet&lt;&gt;();</span>
<span class="nc" id="L49">        this.activeProjects = new HashMap&lt;&gt;();</span>
        
<span class="nc" id="L51">        initializeBuildingRewards();</span>
<span class="nc" id="L52">        initializeDecorativeBlocks();</span>
<span class="nc" id="L53">    }</span>
    
    /**
     * 建築報酬テーブルの初期化
     */
    private void initializeBuildingRewards() {
        // 基本建築材料
<span class="nc" id="L60">        buildingRewards.put(Material.STONE, new BuildingReward(0.5, 1.0, &quot;石&quot;));</span>
<span class="nc" id="L61">        buildingRewards.put(Material.COBBLESTONE, new BuildingReward(0.3, 0.8, &quot;丸石&quot;));</span>
<span class="nc" id="L62">        buildingRewards.put(Material.STONE_BRICKS, new BuildingReward(1.0, 2.0, &quot;石レンガ&quot;));</span>
        
        // 木材系
<span class="nc" id="L65">        buildingRewards.put(Material.OAK_PLANKS, new BuildingReward(0.8, 1.5, &quot;オークの板材&quot;));</span>
<span class="nc" id="L66">        buildingRewards.put(Material.BIRCH_PLANKS, new BuildingReward(0.8, 1.5, &quot;シラカバの板材&quot;));</span>
<span class="nc" id="L67">        buildingRewards.put(Material.SPRUCE_PLANKS, new BuildingReward(0.8, 1.5, &quot;トウヒの板材&quot;));</span>
<span class="nc" id="L68">        buildingRewards.put(Material.JUNGLE_PLANKS, new BuildingReward(1.0, 2.0, &quot;ジャングルの板材&quot;));</span>
<span class="nc" id="L69">        buildingRewards.put(Material.ACACIA_PLANKS, new BuildingReward(1.0, 2.0, &quot;アカシアの板材&quot;));</span>
<span class="nc" id="L70">        buildingRewards.put(Material.DARK_OAK_PLANKS, new BuildingReward(1.0, 2.0, &quot;ダークオークの板材&quot;));</span>
        
        // レンガ系
<span class="nc" id="L73">        buildingRewards.put(Material.BRICKS, new BuildingReward(2.0, 4.0, &quot;レンガ&quot;));</span>
<span class="nc" id="L74">        buildingRewards.put(Material.NETHER_BRICKS, new BuildingReward(3.0, 6.0, &quot;ネザーレンガ&quot;));</span>
<span class="nc" id="L75">        buildingRewards.put(Material.RED_NETHER_BRICKS, new BuildingReward(3.5, 7.0, &quot;赤いネザーレンガ&quot;));</span>
        
        // 高級建築材料
<span class="nc" id="L78">        buildingRewards.put(Material.QUARTZ_BLOCK, new BuildingReward(5.0, 10.0, &quot;クォーツブロック&quot;));</span>
<span class="nc" id="L79">        buildingRewards.put(Material.CHISELED_QUARTZ_BLOCK, new BuildingReward(6.0, 12.0, &quot;模様入りクォーツ&quot;));</span>
<span class="nc" id="L80">        buildingRewards.put(Material.QUARTZ_PILLAR, new BuildingReward(6.0, 12.0, &quot;クォーツの柱&quot;));</span>
        
        // 特殊ブロック
<span class="nc" id="L83">        buildingRewards.put(Material.OBSIDIAN, new BuildingReward(10.0, 20.0, &quot;黒曜石&quot;));</span>
<span class="nc" id="L84">        buildingRewards.put(Material.END_STONE, new BuildingReward(8.0, 15.0, &quot;エンドストーン&quot;));</span>
<span class="nc" id="L85">        buildingRewards.put(Material.PURPUR_BLOCK, new BuildingReward(7.0, 14.0, &quot;プルプァブロック&quot;));</span>
        
        // 装飾ブロック
<span class="nc" id="L88">        buildingRewards.put(Material.CHISELED_STONE_BRICKS, new BuildingReward(3.0, 6.0, &quot;模様入り石レンガ&quot;));</span>
<span class="nc" id="L89">        buildingRewards.put(Material.MOSSY_STONE_BRICKS, new BuildingReward(2.5, 5.0, &quot;苔石レンガ&quot;));</span>
<span class="nc" id="L90">        buildingRewards.put(Material.CRACKED_STONE_BRICKS, new BuildingReward(2.0, 4.0, &quot;ひび入り石レンガ&quot;));</span>
        
        // ガラス系
<span class="nc" id="L93">        buildingRewards.put(Material.GLASS, new BuildingReward(1.5, 3.0, &quot;ガラス&quot;));</span>
<span class="nc" id="L94">        buildingRewards.put(Material.WHITE_STAINED_GLASS, new BuildingReward(2.0, 4.0, &quot;白色のガラス&quot;));</span>
<span class="nc" id="L95">        buildingRewards.put(Material.BLUE_STAINED_GLASS, new BuildingReward(2.0, 4.0, &quot;青色のガラス&quot;));</span>
        // 他の色ガラスも同様に設定...
        
        // 1.16以降のブロック
<span class="nc" id="L99">        buildingRewards.put(Material.BLACKSTONE, new BuildingReward(1.0, 2.0, &quot;ブラックストーン&quot;));</span>
<span class="nc" id="L100">        buildingRewards.put(Material.POLISHED_BLACKSTONE, new BuildingReward(2.0, 4.0, &quot;磨かれたブラックストーン&quot;));</span>
<span class="nc" id="L101">        buildingRewards.put(Material.CHISELED_POLISHED_BLACKSTONE, new BuildingReward(3.0, 6.0, &quot;模様入り磨かれたブラックストーン&quot;));</span>
<span class="nc" id="L102">    }</span>
    
    /**
     * 建築家専用装飾ブロックの初期化
     */
    private void initializeDecorativeBlocks() {
        // 高レベル建築家のみ使用可能な装飾ブロック
<span class="nc" id="L109">        decorativeBlocks.add(Material.CHISELED_QUARTZ_BLOCK);</span>
<span class="nc" id="L110">        decorativeBlocks.add(Material.QUARTZ_PILLAR);</span>
<span class="nc" id="L111">        decorativeBlocks.add(Material.CHISELED_STONE_BRICKS);</span>
<span class="nc" id="L112">        decorativeBlocks.add(Material.CHISELED_POLISHED_BLACKSTONE);</span>
<span class="nc" id="L113">        decorativeBlocks.add(Material.CHISELED_SANDSTONE);</span>
<span class="nc" id="L114">        decorativeBlocks.add(Material.CHISELED_RED_SANDSTONE);</span>
<span class="nc" id="L115">        decorativeBlocks.add(Material.CARVED_PUMPKIN);</span>
<span class="nc" id="L116">        decorativeBlocks.add(Material.JACK_O_LANTERN);</span>
        
        // ビーコンやコンジット等の特殊建築ブロック
<span class="nc" id="L119">        decorativeBlocks.add(Material.BEACON);</span>
<span class="nc" id="L120">        decorativeBlocks.add(Material.CONDUIT);</span>
        
        // エンドゲーム装飾
<span class="nc" id="L123">        decorativeBlocks.add(Material.END_ROD);</span>
<span class="nc" id="L124">        decorativeBlocks.add(Material.CHORUS_PLANT);</span>
<span class="nc" id="L125">        decorativeBlocks.add(Material.CHORUS_FLOWER);</span>
<span class="nc" id="L126">    }</span>
    
    /**
     * ブロック設置イベントの処理
     */
    public void handleBlockPlace(BlockPlaceEvent event) {
<span class="nc" id="L132">        Player player = event.getPlayer();</span>
<span class="nc" id="L133">        Block block = event.getBlockPlaced();</span>
<span class="nc" id="L134">        Material material = block.getType();</span>
        
        // 建築家の職業チェック
<span class="nc" id="L137">        PlayerJob builderJob = jobManager.getPlayerJob(player, &quot;builder&quot;);</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">        if (builderJob == null || !builderJob.isActive()) {</span>
            // 建築家でない場合は装飾ブロック制限をチェック
<span class="nc bnc" id="L140" title="All 4 branches missed.">            if (decorativeBlocks.contains(material) &amp;&amp; !hasDecorativePermission(player, material)) {</span>
<span class="nc" id="L141">                event.setCancelled(true);</span>
<span class="nc" id="L142">                player.sendMessage(ChatColor.RED + &quot;このブロックは建築家レベル20以上でないと設置できません！&quot;);</span>
<span class="nc" id="L143">                return;</span>
            }
<span class="nc" id="L145">            return;</span>
        }
        
        // 装飾ブロック権限チェック
<span class="nc bnc" id="L149" title="All 4 branches missed.">        if (decorativeBlocks.contains(material) &amp;&amp; !canUseDecorativeBlock(builderJob, material)) {</span>
<span class="nc" id="L150">            event.setCancelled(true);</span>
<span class="nc" id="L151">            player.sendMessage(ChatColor.RED + &quot;このブロックを使用するには建築家レベル&quot; + </span>
<span class="nc" id="L152">                             getRequiredLevel(material) + &quot;以上が必要です！&quot;);</span>
<span class="nc" id="L153">            return;</span>
        }
        
        // 建築報酬を処理
<span class="nc" id="L157">        processBuildingReward(player, builderJob, material, block.getLocation());</span>
<span class="nc" id="L158">    }</span>
    
    /**
     * 建築報酬の処理
     */
    private void processBuildingReward(Player player, PlayerJob builderJob, 
                                      Material material, Location location) {
<span class="nc" id="L165">        BuildingReward reward = buildingRewards.get(material);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (reward == null) {</span>
            // 未定義のブロックは基本報酬
<span class="nc" id="L168">            reward = new BuildingReward(0.1, 0.2, material.name().toLowerCase());</span>
        }
        
        // レベルボーナスを適用
<span class="nc" id="L172">        double levelMultiplier = 1.0 + (builderJob.getLevel() * 0.025); // レベル毎に2.5%ボーナス</span>
        
<span class="nc" id="L174">        double finalExperience = reward.getExperience() * levelMultiplier;</span>
<span class="nc" id="L175">        double finalIncome = reward.getIncome() * levelMultiplier;</span>
        
        // 建築プロジェクトボーナスをチェック
<span class="nc" id="L178">        double projectBonus = checkBuildingProjectBonus(player, location, material);</span>
<span class="nc" id="L179">        finalExperience *= projectBonus;</span>
<span class="nc" id="L180">        finalIncome *= projectBonus;</span>
        
        // 非同期で報酬を付与
<span class="nc" id="L183">        String playerUUID = player.getUniqueId().toString();</span>
<span class="nc" id="L184">        asyncUpdater.updateJobExperience(playerUUID, &quot;builder&quot;, finalExperience);</span>
<span class="nc" id="L185">        asyncUpdater.updatePlayerBalance(playerUUID, finalIncome, &quot;建築報酬&quot;);</span>
        
        // 建築スキル発動チェック
<span class="nc" id="L188">        checkBuildingSkills(player, builderJob, material, location);</span>
        
        // 大規模建築の場合のみメッセージ表示
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (reward.getExperience() &gt;= 2.0) {</span>
<span class="nc" id="L192">            String message = String.format(</span>
                &quot;%s%sを設置！ §a+%.1f経験値 §6+%.1f金塊&quot;,
                ChatColor.GRAY,
<span class="nc" id="L195">                reward.getDisplayName(),</span>
<span class="nc" id="L196">                finalExperience,</span>
<span class="nc" id="L197">                finalIncome</span>
            );
<span class="nc" id="L199">            player.sendMessage(message);</span>
        }
<span class="nc" id="L201">    }</span>
    
    /**
     * 建築プロジェクトボーナスをチェック
     */
    private double checkBuildingProjectBonus(Player player, Location location, Material material) {
<span class="nc" id="L207">        String playerUUID = player.getUniqueId().toString();</span>
<span class="nc" id="L208">        BuildingProject project = activeProjects.get(playerUUID);</span>
        
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (project == null) {</span>
            // 新しいプロジェクトを開始
<span class="nc" id="L212">            project = new BuildingProject(location, material);</span>
<span class="nc" id="L213">            activeProjects.put(playerUUID, project);</span>
<span class="nc" id="L214">            return 1.0;</span>
        }
        
        // 既存プロジェクトとの関連性をチェック
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (project.isRelatedBlock(location, material)) {</span>
<span class="nc" id="L219">            project.addBlock(location, material);</span>
            
            // プロジェクト規模によるボーナス
<span class="nc" id="L222">            int blockCount = project.getBlockCount();</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            if (blockCount &gt;= 100) {</span>
<span class="nc" id="L224">                return 2.0; // 大規模建築：100%ボーナス</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            } else if (blockCount &gt;= 50) {</span>
<span class="nc" id="L226">                return 1.5; // 中規模建築：50%ボーナス</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            } else if (blockCount &gt;= 20) {</span>
<span class="nc" id="L228">                return 1.2; // 小規模建築：20%ボーナス</span>
            }
<span class="nc" id="L230">        } else {</span>
            // 新しいプロジェクト開始
<span class="nc" id="L232">            activeProjects.put(playerUUID, new BuildingProject(location, material));</span>
        }
        
<span class="nc" id="L235">        return 1.0;</span>
    }
    
    /**
     * 建築スキルの発動チェック
     */
    private void checkBuildingSkills(Player player, PlayerJob job, Material material, Location location) {
<span class="nc" id="L242">        int level = job.getLevel();</span>
        
        // レベル15以上：効率建築
<span class="nc bnc" id="L245" title="All 4 branches missed.">        if (level &gt;= 15 &amp;&amp; Math.random() &lt; 0.1) { // 10%の確率</span>
            // ブロックを設置する際にスタミナ（満腹度）を回復
<span class="nc" id="L247">            int currentFood = player.getFoodLevel();</span>
<span class="nc" id="L248">            player.setFoodLevel(Math.min(20, currentFood + 1));</span>
<span class="nc" id="L249">            player.sendMessage(ChatColor.GREEN + &quot;✦ 効率建築！建築によりスタミナが回復しました！&quot;);</span>
        }
        
        // レベル30以上：材料節約
<span class="nc bnc" id="L253" title="All 4 branches missed.">        if (level &gt;= 30 &amp;&amp; Math.random() &lt; 0.15) { // 15%の確率</span>
            // プレイヤーに同じ材料を1個返却
<span class="nc" id="L255">            ItemStack item = new ItemStack(material, 1);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (player.getInventory().firstEmpty() != -1) {</span>
<span class="nc" id="L257">                player.getInventory().addItem(item);</span>
            } else {
<span class="nc" id="L259">                player.getWorld().dropItem(location, item);</span>
            }
<span class="nc" id="L261">            player.sendMessage(ChatColor.GOLD + &quot;✦ 材料節約！材料が1個返却されました！&quot;);</span>
        }
        
        // レベル50以上：建築の達人
<span class="nc bnc" id="L265" title="All 4 branches missed.">        if (level &gt;= 50 &amp;&amp; Math.random() &lt; 0.05) { // 5%の確率</span>
            // 周囲に同じブロックを自動配置
<span class="nc" id="L267">            autoPlaceBlocks(player, location, material);</span>
<span class="nc" id="L268">            player.sendMessage(ChatColor.GOLD + &quot;✦ 建築の達人！周囲にブロックが自動配置されました！&quot;);</span>
        }
        
        // レベル75以上：建築家の直感
<span class="nc bnc" id="L272" title="All 4 branches missed.">        if (level &gt;= 75 &amp;&amp; Math.random() &lt; 0.03) { // 3%の確率</span>
            // プレイヤーに建築に有用な追加材料を付与
<span class="nc" id="L274">            giveBuilderBonus(player, material);</span>
<span class="nc" id="L275">            player.sendMessage(ChatColor.GOLD + &quot;✦ 建築家の直感！追加材料を発見しました！&quot;);</span>
        }
<span class="nc" id="L277">    }</span>
    
    /**
     * 自動ブロック配置
     */
    private void autoPlaceBlocks(Player player, Location centerLocation, Material material) {
        // プレイヤーのインベントリに同じ材料があるかチェック
<span class="nc" id="L284">        int availableBlocks = 0;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        for (ItemStack item : player.getInventory().getContents()) {</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">            if (item != null &amp;&amp; item.getType() == material) {</span>
<span class="nc" id="L287">                availableBlocks += item.getAmount();</span>
            }
        }
        
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (availableBlocks &lt;= 1) return;</span>
        
        // 周囲のブロックを配置（最大4個）
<span class="nc" id="L294">        int placed = 0;</span>
<span class="nc" id="L295">        Location[] directions = {</span>
<span class="nc" id="L296">            centerLocation.clone().add(1, 0, 0),</span>
<span class="nc" id="L297">            centerLocation.clone().add(-1, 0, 0),</span>
<span class="nc" id="L298">            centerLocation.clone().add(0, 0, 1),</span>
<span class="nc" id="L299">            centerLocation.clone().add(0, 0, -1)</span>
        };
        
<span class="nc bnc" id="L302" title="All 2 branches missed.">        for (Location loc : directions) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (placed &gt;= Math.min(4, availableBlocks - 1)) break;</span>
            
<span class="nc" id="L305">            Block block = loc.getBlock();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if (block.getType() == Material.AIR) {</span>
<span class="nc" id="L307">                block.setType(material);</span>
<span class="nc" id="L308">                player.getInventory().removeItem(new ItemStack(material, 1));</span>
<span class="nc" id="L309">                placed++;</span>
            }
        }
<span class="nc" id="L312">    }</span>
    
    /**
     * 建築家ボーナス材料を付与
     */
    private void giveBuilderBonus(Player player, Material placedMaterial) {
        // 配置したブロックに関連する材料を付与
<span class="nc" id="L319">        Material bonusMaterial = getRelatedMaterial(placedMaterial);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (bonusMaterial != null) {</span>
<span class="nc" id="L321">            ItemStack bonus = new ItemStack(bonusMaterial, 1 + (int)(Math.random() * 3));</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            if (player.getInventory().firstEmpty() != -1) {</span>
<span class="nc" id="L323">                player.getInventory().addItem(bonus);</span>
            } else {
<span class="nc" id="L325">                player.getWorld().dropItem(player.getLocation(), bonus);</span>
            }
        }
<span class="nc" id="L328">    }</span>
    
    /**
     * 関連材料を取得
     */
    private Material getRelatedMaterial(Material material) {
        // 材料の種類に応じて関連材料を返す
<span class="nc" id="L335">        String name = material.name();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (name.contains(&quot;STONE&quot;)) {</span>
<span class="nc" id="L337">            return Material.STONE;</span>
<span class="nc bnc" id="L338" title="All 4 branches missed.">        } else if (name.contains(&quot;WOOD&quot;) || name.contains(&quot;PLANK&quot;)) {</span>
<span class="nc" id="L339">            return Material.OAK_PLANKS;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">        } else if (name.contains(&quot;BRICK&quot;)) {</span>
<span class="nc" id="L341">            return Material.BRICKS;</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">        } else if (name.contains(&quot;QUARTZ&quot;)) {</span>
<span class="nc" id="L343">            return Material.QUARTZ;</span>
        }
<span class="nc" id="L345">        return null;</span>
    }
    
    /**
     * 装飾ブロック使用権限チェック
     */
    private boolean canUseDecorativeBlock(PlayerJob job, Material material) {
<span class="nc" id="L352">        int requiredLevel = getRequiredLevel(material);</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">        return job.getLevel() &gt;= requiredLevel;</span>
    }
    
    /**
     * 一般プレイヤーの装飾ブロック権限チェック
     */
    private boolean hasDecorativePermission(Player player, Material material) {
        // 一般プレイヤーは基本的な装飾ブロックのみ使用可能
<span class="nc bnc" id="L361" title="All 2 branches missed.">        return !decorativeBlocks.contains(material) || </span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">               player.hasPermission(&quot;tofunomics.builder.decorative&quot;);</span>
    }
    
    /**
     * ブロックに必要なレベルを取得
     */
    private int getRequiredLevel(Material material) {
<span class="nc bnc" id="L369" title="All 5 branches missed.">        switch (material) {</span>
            case CHISELED_QUARTZ_BLOCK:
            case QUARTZ_PILLAR:
<span class="nc" id="L372">                return 20;</span>
            case CHISELED_STONE_BRICKS:
            case CHISELED_POLISHED_BLACKSTONE:
<span class="nc" id="L375">                return 30;</span>
            case BEACON:
            case CONDUIT:
<span class="nc" id="L378">                return 50;</span>
            case END_ROD:
            case CHORUS_PLANT:
<span class="nc" id="L381">                return 60;</span>
            default:
<span class="nc" id="L383">                return 20;</span>
        }
    }
    
    /**
     * 建築報酬クラス
     */
    private static class BuildingReward {
        private final double experience;
        private final double income;
        private final String displayName;
        
<span class="nc" id="L395">        public BuildingReward(double experience, double income, String displayName) {</span>
<span class="nc" id="L396">            this.experience = experience;</span>
<span class="nc" id="L397">            this.income = income;</span>
<span class="nc" id="L398">            this.displayName = displayName;</span>
<span class="nc" id="L399">        }</span>
        
<span class="nc" id="L401">        public double getExperience() { return experience; }</span>
<span class="nc" id="L402">        public double getIncome() { return income; }</span>
<span class="nc" id="L403">        public String getDisplayName() { return displayName; }</span>
    }
    
    /**
     * 建築プロジェクトクラス
     */
    private static class BuildingProject {
        private final Location startLocation;
        private final Material primaryMaterial;
        private final Set&lt;Location&gt; blockLocations;
        private final long startTime;
        
<span class="nc" id="L415">        public BuildingProject(Location startLocation, Material primaryMaterial) {</span>
<span class="nc" id="L416">            this.startLocation = startLocation;</span>
<span class="nc" id="L417">            this.primaryMaterial = primaryMaterial;</span>
<span class="nc" id="L418">            this.blockLocations = new HashSet&lt;&gt;();</span>
<span class="nc" id="L419">            this.startTime = System.currentTimeMillis();</span>
            
<span class="nc" id="L421">            blockLocations.add(startLocation);</span>
<span class="nc" id="L422">        }</span>
        
        public boolean isRelatedBlock(Location location, Material material) {
            // 開始地点から50ブロック以内で、同じ材料系統の場合は関連ブロックとする
<span class="nc bnc" id="L426" title="All 2 branches missed.">            if (location.distance(startLocation) &gt; 50) {</span>
<span class="nc" id="L427">                return false;</span>
            }
            
            // 材料系統の判定（簡略化）
<span class="nc" id="L431">            return isSameMaterialFamily(primaryMaterial, material);</span>
        }
        
        private boolean isSameMaterialFamily(Material mat1, Material mat2) {
<span class="nc" id="L435">            String name1 = mat1.name();</span>
<span class="nc" id="L436">            String name2 = mat2.name();</span>
            
            // 同じ材料系統かチェック
<span class="nc bnc" id="L439" title="All 4 branches missed.">            if (name1.contains(&quot;STONE&quot;) &amp;&amp; name2.contains(&quot;STONE&quot;)) return true;</span>
<span class="nc bnc" id="L440" title="All 4 branches missed.">            if (name1.contains(&quot;WOOD&quot;) &amp;&amp; name2.contains(&quot;WOOD&quot;)) return true;</span>
<span class="nc bnc" id="L441" title="All 4 branches missed.">            if (name1.contains(&quot;PLANK&quot;) &amp;&amp; name2.contains(&quot;PLANK&quot;)) return true;</span>
<span class="nc bnc" id="L442" title="All 4 branches missed.">            if (name1.contains(&quot;BRICK&quot;) &amp;&amp; name2.contains(&quot;BRICK&quot;)) return true;</span>
<span class="nc bnc" id="L443" title="All 4 branches missed.">            if (name1.contains(&quot;QUARTZ&quot;) &amp;&amp; name2.contains(&quot;QUARTZ&quot;)) return true;</span>
            
<span class="nc bnc" id="L445" title="All 2 branches missed.">            return mat1 == mat2;</span>
        }
        
        public void addBlock(Location location, Material material) {
<span class="nc" id="L449">            blockLocations.add(location);</span>
<span class="nc" id="L450">        }</span>
        
        public int getBlockCount() {
<span class="nc" id="L453">            return blockLocations.size();</span>
        }
        
        public boolean isExpired() {
            // 1時間で期限切れ
<span class="nc bnc" id="L458" title="All 2 branches missed.">            return System.currentTimeMillis() - startTime &gt; 3600000;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>