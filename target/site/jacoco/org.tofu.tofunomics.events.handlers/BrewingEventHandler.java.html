<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BrewingEventHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TofuNomics</a> &gt; <a href="index.source.html" class="el_package">org.tofu.tofunomics.events.handlers</a> &gt; <span class="el_source">BrewingEventHandler.java</span></div><h1>BrewingEventHandler.java</h1><pre class="source lang-java linenums">package org.tofu.tofunomics.events.handlers;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.block.BrewingStand;
import org.bukkit.entity.Player;
import org.bukkit.event.inventory.BrewEvent;
import org.bukkit.inventory.ItemStack;
import org.tofu.tofunomics.config.ConfigManager;
import org.tofu.tofunomics.dao.PlayerDAO;
import org.tofu.tofunomics.events.AsyncEventUpdater;
import org.tofu.tofunomics.jobs.JobManager;
import org.tofu.tofunomics.models.PlayerJob;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * 醸造イベントハンドラ
 * 調合師の醸造処理を管理
 */
public class BrewingEventHandler {
    
    private final ConfigManager configManager;
    private final PlayerDAO playerDAO;
    private final JobManager jobManager;
    private final AsyncEventUpdater asyncUpdater;
    
    // 醸造台の所有者を追跡
    private final Map&lt;Location, UUID&gt; brewingStandOwners;
    
    // ポーション種別による経験値と収入
    private final Map&lt;Material, PotionReward&gt; potionRewards;
    
    public BrewingEventHandler(ConfigManager configManager, PlayerDAO playerDAO,
<span class="nc" id="L40">                              JobManager jobManager, AsyncEventUpdater asyncUpdater) {</span>
<span class="nc" id="L41">        this.configManager = configManager;</span>
<span class="nc" id="L42">        this.playerDAO = playerDAO;</span>
<span class="nc" id="L43">        this.jobManager = jobManager;</span>
<span class="nc" id="L44">        this.asyncUpdater = asyncUpdater;</span>
<span class="nc" id="L45">        this.brewingStandOwners = new HashMap&lt;&gt;();</span>
<span class="nc" id="L46">        this.potionRewards = new HashMap&lt;&gt;();</span>
        
<span class="nc" id="L48">        initializePotionRewards();</span>
<span class="nc" id="L49">    }</span>
    
    /**
     * ポーション報酬テーブルの初期化
     */
    private void initializePotionRewards() {
        // 通常ポーション
<span class="nc" id="L56">        potionRewards.put(Material.POTION, new PotionReward(2.0, 3.0));</span>
        
        // スプラッシュポーション
<span class="nc" id="L59">        potionRewards.put(Material.SPLASH_POTION, new PotionReward(3.0, 5.0));</span>
        
        // 残留ポーション
<span class="nc" id="L62">        potionRewards.put(Material.LINGERING_POTION, new PotionReward(5.0, 8.0));</span>
        
        // 特殊アイテム（ブレイズパウダー製作など）
<span class="nc" id="L65">        potionRewards.put(Material.BLAZE_POWDER, new PotionReward(1.0, 2.0));</span>
<span class="nc" id="L66">        potionRewards.put(Material.MAGMA_CREAM, new PotionReward(2.0, 3.0));</span>
<span class="nc" id="L67">    }</span>
    
    /**
     * 醸造イベントの処理
     */
    public void handleBrew(BrewEvent event) {
<span class="nc" id="L73">        Block block = event.getBlock();</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (!(block.getState() instanceof BrewingStand)) {</span>
<span class="nc" id="L75">            return;</span>
        }
        
<span class="nc" id="L78">        Location location = block.getLocation();</span>
        
        // 醸造台の所有者を取得
<span class="nc" id="L81">        UUID ownerUUID = brewingStandOwners.get(location);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (ownerUUID == null) {</span>
            // 近くのプレイヤーから所有者を推定
<span class="nc" id="L84">            ownerUUID = findNearestAlchemist(location);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (ownerUUID == null) {</span>
<span class="nc" id="L86">                return;</span>
            }
        }
        
<span class="nc" id="L90">        Player player = Bukkit.getPlayer(ownerUUID);</span>
<span class="nc bnc" id="L91" title="All 4 branches missed.">        if (player == null || !player.isOnline()) {</span>
<span class="nc" id="L92">            return;</span>
        }
        
        // 調合師の職業チェック
<span class="nc" id="L96">        PlayerJob alchemistJob = jobManager.getPlayerJob(player, &quot;alchemist&quot;);</span>
<span class="nc bnc" id="L97" title="All 4 branches missed.">        if (alchemistJob == null || !alchemistJob.isActive()) {</span>
<span class="nc" id="L98">            return;</span>
        }
        
        // 醸造結果を処理
<span class="nc" id="L102">        processBrewingResult(player, alchemistJob, event);</span>
<span class="nc" id="L103">    }</span>
    
    /**
     * 醸造結果の処理
     */
    private void processBrewingResult(Player player, PlayerJob alchemistJob, BrewEvent event) {
<span class="nc" id="L109">        BrewingStand brewingStand = (BrewingStand) event.getBlock().getState();</span>
        
<span class="nc" id="L111">        double totalExperience = 0;</span>
<span class="nc" id="L112">        double totalIncome = 0;</span>
<span class="nc" id="L113">        int potionCount = 0;</span>
        
        // 結果スロットをチェック（0-2番スロット）
<span class="nc bnc" id="L116" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L117">            ItemStack item = event.getContents().getItem(i);</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">            if (item != null &amp;&amp; item.getType() != Material.AIR) {</span>
<span class="nc" id="L119">                PotionReward reward = potionRewards.get(item.getType());</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (reward != null) {</span>
                    // レベルボーナスを適用
<span class="nc" id="L122">                    double levelMultiplier = 1.0 + (alchemistJob.getLevel() * 0.02); // レベル毎に2%ボーナス</span>
                    
<span class="nc" id="L124">                    totalExperience += reward.getExperience() * levelMultiplier;</span>
<span class="nc" id="L125">                    totalIncome += reward.getIncome() * levelMultiplier;</span>
<span class="nc" id="L126">                    potionCount++;</span>
                }
            }
        }
        
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (potionCount &gt; 0) {</span>
            // 経験値とお金を付与
<span class="nc" id="L133">            applyRewards(player, alchemistJob, totalExperience, totalIncome, potionCount);</span>
            
            // 醸造成功率ボーナス（高レベルほど失敗を防ぐ）
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (alchemistJob.getLevel() &gt;= 20) {</span>
<span class="nc" id="L137">                applyBrewingBonus(event, alchemistJob.getLevel());</span>
            }
        }
<span class="nc" id="L140">    }</span>
    
    /**
     * 報酬を適用
     */
    private void applyRewards(Player player, PlayerJob job, double experience, 
                             double income, int potionCount) {
<span class="nc" id="L147">        String playerUUID = player.getUniqueId().toString();</span>
        
        // 非同期で経験値と残高を更新
<span class="nc" id="L150">        asyncUpdater.updateJobExperience(playerUUID, &quot;alchemist&quot;, experience);</span>
<span class="nc" id="L151">        asyncUpdater.updatePlayerBalance(playerUUID, income, &quot;醸造報酬&quot;);</span>
        
        // メッセージ表示
<span class="nc" id="L154">        String message = String.format(</span>
            &quot;%s§f%d個のポーションを醸造しました！ &quot; +
            &quot;§a+%.1f経験値 §6+%.1f金塊&quot;,
            ChatColor.LIGHT_PURPLE,
<span class="nc" id="L158">            potionCount,</span>
<span class="nc" id="L159">            experience,</span>
<span class="nc" id="L160">            income</span>
        );
<span class="nc" id="L162">        player.sendMessage(message);</span>
        
        // レベルアップチェックとスキル発動
<span class="nc" id="L165">        checkLevelUpAndSkills(player, job);</span>
<span class="nc" id="L166">    }</span>
    
    /**
     * 醸造ボーナスの適用
     */
    private void applyBrewingBonus(BrewEvent event, int level) {
        // 高レベルの調合師は追加効果を得る
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (level &gt;= 50) {</span>
            // 50%の確率で材料を消費しない
<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (Math.random() &lt; 0.5) {</span>
<span class="nc" id="L176">                ItemStack ingredient = event.getContents().getIngredient();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                if (ingredient != null) {</span>
<span class="nc" id="L178">                    ingredient.setAmount(ingredient.getAmount() + 1);</span>
                }
<span class="nc" id="L180">            }</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        } else if (level &gt;= 30) {</span>
            // 30%の確率で材料を消費しない
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (Math.random() &lt; 0.3) {</span>
<span class="nc" id="L184">                ItemStack ingredient = event.getContents().getIngredient();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                if (ingredient != null) {</span>
<span class="nc" id="L186">                    ingredient.setAmount(ingredient.getAmount() + 1);</span>
                }
            }
        }
<span class="nc" id="L190">    }</span>
    
    /**
     * レベルアップとスキルチェック
     */
    private void checkLevelUpAndSkills(Player player, PlayerJob job) {
        // スキル発動チェック
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (job.getLevel() &gt;= 10) {</span>
            // ダブル醸造スキル（10%の確率で醸造物が倍になる）
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if (Math.random() &lt; 0.10) {</span>
<span class="nc" id="L200">                player.sendMessage(ChatColor.GOLD + &quot;⚗ ダブル醸造スキル発動！追加のポーションを獲得しました！&quot;);</span>
                // 実際のアイテム付与はメインスレッドで行う必要がある
<span class="nc" id="L202">                Bukkit.getScheduler().runTask(configManager.getPlugin(), () -&gt; {</span>
<span class="nc" id="L203">                    giveExtraPotions(player);</span>
<span class="nc" id="L204">                });</span>
            }
        }
        
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (job.getLevel() &gt;= 25) {</span>
            // 完璧な醸造スキル（ポーション効果時間延長）
<span class="nc bnc" id="L210" title="All 2 branches missed.">            if (Math.random() &lt; 0.15) {</span>
<span class="nc" id="L211">                player.sendMessage(ChatColor.GOLD + &quot;⚗ 完璧な醸造！ポーション効果が強化されました！&quot;);</span>
            }
        }
<span class="nc" id="L214">    }</span>
    
    /**
     * 追加ポーションを付与
     */
    private void giveExtraPotions(Player player) {
        // プレイヤーのインベントリに空きがある場合、ランダムなポーションを追加
<span class="nc" id="L221">        ItemStack potion = new ItemStack(Material.POTION);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (player.getInventory().firstEmpty() != -1) {</span>
<span class="nc" id="L223">            player.getInventory().addItem(potion);</span>
        } else {
<span class="nc" id="L225">            player.getWorld().dropItem(player.getLocation(), potion);</span>
        }
<span class="nc" id="L227">    }</span>
    
    /**
     * 最も近い調合師を探す
     */
    private UUID findNearestAlchemist(Location location) {
<span class="nc" id="L233">        double nearestDistance = Double.MAX_VALUE;</span>
<span class="nc" id="L234">        UUID nearestAlchemist = null;</span>
        
<span class="nc bnc" id="L236" title="All 2 branches missed.">        for (Player player : location.getWorld().getPlayers()) {</span>
<span class="nc" id="L237">            double distance = player.getLocation().distance(location);</span>
<span class="nc bnc" id="L238" title="All 4 branches missed.">            if (distance &lt; 10 &amp;&amp; distance &lt; nearestDistance) { // 10ブロック以内</span>
<span class="nc" id="L239">                PlayerJob job = jobManager.getPlayerJob(player, &quot;alchemist&quot;);</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">                if (job != null &amp;&amp; job.isActive()) {</span>
<span class="nc" id="L241">                    nearestDistance = distance;</span>
<span class="nc" id="L242">                    nearestAlchemist = player.getUniqueId();</span>
                }
            }
<span class="nc" id="L245">        }</span>
        
<span class="nc" id="L247">        return nearestAlchemist;</span>
    }
    
    /**
     * 醸造台の所有者を設定
     */
    public void setBrewingStandOwner(Location location, Player player) {
<span class="nc" id="L254">        brewingStandOwners.put(location, player.getUniqueId());</span>
<span class="nc" id="L255">    }</span>
    
    /**
     * 醸造台の所有者を削除
     */
    public void removeBrewingStandOwner(Location location) {
<span class="nc" id="L261">        brewingStandOwners.remove(location);</span>
<span class="nc" id="L262">    }</span>
    
    /**
     * ポーション報酬クラス
     */
    private static class PotionReward {
        private final double experience;
        private final double income;
        
<span class="nc" id="L271">        public PotionReward(double experience, double income) {</span>
<span class="nc" id="L272">            this.experience = experience;</span>
<span class="nc" id="L273">            this.income = income;</span>
<span class="nc" id="L274">        }</span>
        
<span class="nc" id="L276">        public double getExperience() { return experience; }</span>
<span class="nc" id="L277">        public double getIncome() { return income; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>