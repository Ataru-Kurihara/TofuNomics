<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TofuNomics.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TofuNomics</a> &gt; <a href="index.source.html" class="el_package">org.tofu.tofunomics</a> &gt; <span class="el_source">TofuNomics.java</span></div><h1>TofuNomics.java</h1><pre class="source lang-java linenums">package org.tofu.tofunomics;

import org.bukkit.plugin.java.JavaPlugin;
import org.tofu.tofunomics.database.DatabaseManager;
import org.tofu.tofunomics.dao.PlayerDAO;
import org.tofu.tofunomics.dao.JobDAO;
import org.tofu.tofunomics.dao.PlayerJobDAO;
import org.tofu.tofunomics.dao.JobChangeDAO;
import org.tofu.tofunomics.config.ConfigManager;
import org.tofu.tofunomics.economy.ItemManager;
import org.tofu.tofunomics.economy.CurrencyConverter;
import org.tofu.tofunomics.economy.BankLocationManager;
import org.tofu.tofunomics.jobs.JobManager;
import org.tofu.tofunomics.jobs.ExperienceManager;
import org.tofu.tofunomics.commands.*;
import org.tofu.tofunomics.tools.JobToolManager;
import org.tofu.tofunomics.experience.JobExperienceManager;
import org.tofu.tofunomics.income.JobIncomeManager;
import org.tofu.tofunomics.quests.JobQuestManager;
import org.tofu.tofunomics.rewards.JobLevelRewardManager;
import org.tofu.tofunomics.stats.JobStatsManager;

import java.io.File;

<span class="nc" id="L25">public final class TofuNomics extends JavaPlugin {</span>
    
    private static TofuNomics instance;
    private DatabaseManager databaseManager;
    private PlayerDAO playerDAO;
    private JobDAO jobDAO;
    private PlayerJobDAO playerJobDAO;
    private JobChangeDAO jobChangeDAO;
    private ConfigManager configManager;
    private ItemManager itemManager;
    private CurrencyConverter currencyConverter;
    private BankLocationManager bankLocationManager;
    private JobManager jobManager;
    private ExperienceManager experienceManager;
    
    // Phase 3 新機能マネージャー
    private JobToolManager jobToolManager;
    private JobExperienceManager jobExperienceManager;
    private JobIncomeManager jobIncomeManager;
    private JobQuestManager jobQuestManager;
    private JobLevelRewardManager jobLevelRewardManager;
    private JobStatsManager jobStatsManager;
    private org.tofu.tofunomics.jobs.JobBlockPermissionManager jobBlockPermissionManager;
    
    // Phase 6 クラフト制限システム
    private org.tofu.tofunomics.jobs.JobCraftPermissionManager jobCraftPermissionManager;
    
    // Phase 4 取引システムマネージャー
    private org.tofu.tofunomics.trade.TradeChestManager tradeChestManager;
    private org.tofu.tofunomics.trade.TradePriceManager tradePriceManager;
    private org.tofu.tofunomics.trade.TradeChestListener tradeChestListener;
    
    // Phase 5 統合イベントシステム
    private org.tofu.tofunomics.events.UnifiedEventHandler unifiedEventHandler;
    
    // Phase 6 クラフト制限専用イベントハンドラー（緊急対応）
    private org.tofu.tofunomics.events.CraftRestrictionEventHandler craftRestrictionEventHandler;
    
    // プレイヤー参加時処理
    private org.tofu.tofunomics.players.PlayerJoinHandler playerJoinHandler;
    
    // スコアボードシステム
    private org.tofu.tofunomics.scoreboard.ScoreboardManager scoreboardManager;
    
    // NPCシステム（新機能）
    private org.tofu.tofunomics.npc.NPCManager npcManager;
    private org.tofu.tofunomics.npc.BankNPCManager bankNPCManager;
    private org.tofu.tofunomics.npc.TradingNPCManager tradingNPCManager;
    private org.tofu.tofunomics.npc.FoodNPCManager foodNPCManager;
    private org.tofu.tofunomics.npc.NPCListener npcListener;
    private org.tofu.tofunomics.npc.gui.BankGUI bankGUI;
    private org.tofu.tofunomics.npc.gui.TradingGUI tradingGUI;
    private org.tofu.tofunomics.npc.gui.FoodGUI foodGUI;

    @Override
    public void onEnable() {
<span class="nc" id="L81">        instance = this;</span>
        
<span class="nc" id="L83">        getLogger().info(&quot;TofuNomicsプラグインを有効化しています...&quot;);</span>
        
        // 設定ファイルの初期化
<span class="nc" id="L86">        saveDefaultConfig();</span>
        
        // ConfigManagerの初期化
<span class="nc" id="L89">        this.configManager = new ConfigManager(this);</span>
        
        // 設定の自動初期化を実行
<span class="nc" id="L92">        initializeAutoConfig();</span>
        
        // データベースの初期化
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (!initializeDatabase()) {</span>
<span class="nc" id="L96">            getLogger().severe(&quot;データベースの初期化に失敗しました。プラグインを無効化します。&quot;);</span>
<span class="nc" id="L97">            getServer().getPluginManager().disablePlugin(this);</span>
<span class="nc" id="L98">            return;</span>
        }
        
        // DAOの初期化
<span class="nc" id="L102">        initializeDAOs();</span>
        
        // マネージャーの初期化
<span class="nc" id="L105">        initializeManagers();</span>
        
        // Phase 3 新機能マネージャーの初期化
<span class="nc" id="L108">        initializePhase3Managers();</span>
        
        // Phase 4 取引システムの初期化
<span class="nc" id="L111">        initializePhase4TradeSystem();</span>
        
        // Phase 5 統合イベントシステムの初期化
<span class="nc" id="L114">        initializePhase5EventSystem();</span>
        
        // スコアボードシステムの初期化
<span class="nc" id="L117">        initializeScoreboardSystem();</span>
        
        // プレイヤー参加時処理の初期化
<span class="nc" id="L120">        initializePlayerJoinHandler();</span>
        
        // NPCシステムの初期化（新機能）
<span class="nc" id="L123">        initializeNPCSystem();</span>
        
        // イベントリスナーの登録
<span class="nc" id="L126">        registerEventListeners();</span>
        
        // コマンドハンドラーの登録
<span class="nc" id="L129">        registerCommands();</span>
        
<span class="nc" id="L131">        getLogger().info(&quot;TofuNomicsプラグインが正常に有効化されました！&quot;);</span>
<span class="nc" id="L132">    }</span>

    @Override
    public void onDisable() {
<span class="nc" id="L136">        getLogger().info(&quot;TofuNomicsプラグインを無効化しています...&quot;);</span>
        
        // Phase 5 統合イベントシステムのクリーンアップ
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (unifiedEventHandler != null) {</span>
<span class="nc" id="L140">            unifiedEventHandler.cleanup();</span>
        }
        
        // スコアボードシステムのクリーンアップ
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (scoreboardManager != null) {</span>
<span class="nc" id="L145">            scoreboardManager.shutdown();</span>
        }
        
        // NPCシステムのクリーンアップ
<span class="nc" id="L149">        cleanupNPCSystem();</span>
        
        // データベース接続を閉じる
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (databaseManager != null) {</span>
<span class="nc" id="L153">            databaseManager.disconnect();</span>
        }
        
<span class="nc" id="L156">        getLogger().info(&quot;TofuNomicsプラグインが無効化されました。&quot;);</span>
<span class="nc" id="L157">    }</span>
    
    private boolean initializeDatabase() {
        try {
            // データベースファイルのパスを設定
<span class="nc" id="L162">            File dataFolder = getDataFolder();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (!dataFolder.exists()) {</span>
<span class="nc" id="L164">                dataFolder.mkdirs();</span>
            }
            
<span class="nc" id="L167">            String databasePath = new File(dataFolder, &quot;tofunomics.db&quot;).getAbsolutePath();</span>
            
            // DatabaseManagerの初期化
<span class="nc" id="L170">            databaseManager = new DatabaseManager(databasePath, getLogger());</span>
            
            // データベースに接続
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (!databaseManager.connect()) {</span>
<span class="nc" id="L174">                return false;</span>
            }
            
            // テーブルを作成
<span class="nc" id="L178">            databaseManager.createTables();</span>
            
<span class="nc" id="L180">            return true;</span>
<span class="nc" id="L181">        } catch (Exception e) {</span>
<span class="nc" id="L182">            getLogger().severe(&quot;データベース初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L183">            e.printStackTrace();</span>
<span class="nc" id="L184">            return false;</span>
        }
    }
    
    private void initializeDAOs() {
<span class="nc bnc" id="L189" title="All 4 branches missed.">        if (databaseManager != null &amp;&amp; databaseManager.isConnected()) {</span>
<span class="nc" id="L190">            playerDAO = new PlayerDAO(databaseManager.getConnection());</span>
<span class="nc" id="L191">            jobDAO = new JobDAO(databaseManager.getConnection());</span>
<span class="nc" id="L192">            playerJobDAO = new PlayerJobDAO(databaseManager.getConnection());</span>
<span class="nc" id="L193">            jobChangeDAO = new JobChangeDAO(databaseManager.getConnection());</span>
            
<span class="nc" id="L195">            getLogger().info(&quot;データアクセス層（DAO）を初期化しました&quot;);</span>
        }
<span class="nc" id="L197">    }</span>
    
    private void initializeManagers() {
        try {
            // ConfigManagerは既にonEnable()で初期化済み
            
            // ItemManagerの初期化
<span class="nc" id="L204">            itemManager = new ItemManager(configManager);</span>
            
            // CurrencyConverterの初期化
<span class="nc" id="L207">            currencyConverter = new CurrencyConverter(</span>
                playerDAO, 
                itemManager, 
                configManager,
<span class="nc" id="L211">                configManager.getCurrencyDecimalPlaces()</span>
            );
            
            // BankLocationManagerの初期化
<span class="nc" id="L215">            bankLocationManager = new BankLocationManager(configManager);</span>
            
            // JobManagerの初期化
<span class="nc" id="L218">            jobManager = new JobManager(</span>
                configManager,
                jobDAO,
                playerDAO,
                playerJobDAO,
                jobChangeDAO
            );
            
            // ExperienceManagerの初期化
<span class="nc" id="L227">            experienceManager = new ExperienceManager(configManager, playerJobDAO);</span>
            
<span class="nc" id="L229">            getLogger().info(&quot;マネージャーを初期化しました&quot;);</span>
<span class="nc" id="L230">        } catch (Exception e) {</span>
<span class="nc" id="L231">            getLogger().severe(&quot;マネージャー初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L232">            e.printStackTrace();</span>
<span class="nc" id="L233">        }</span>
<span class="nc" id="L234">    }</span>
    
    private void initializePhase3Managers() {
        try {
            // JobToolManagerの初期化
<span class="nc" id="L239">            jobToolManager = new JobToolManager(configManager);</span>
            
            // JobLevelRewardManagerの初期化
<span class="nc" id="L242">            jobLevelRewardManager = new JobLevelRewardManager(configManager, playerDAO);</span>
            
            // JobExperienceManagerの初期化
<span class="nc" id="L245">            jobExperienceManager = new JobExperienceManager(</span>
                configManager, 
                playerJobDAO, 
                jobDAO, 
                jobManager, 
                jobToolManager,
                experienceManager
            );
            
            // JobIncomeManagerの初期化
<span class="nc" id="L255">            jobIncomeManager = new JobIncomeManager(</span>
                configManager, 
                playerDAO, 
                jobManager
            );
            
            // JobQuestManagerの初期化
<span class="nc" id="L262">            jobQuestManager = new JobQuestManager(</span>
                configManager, 
                playerDAO, 
                jobManager
            );
            
            // JobStatsManagerの初期化
<span class="nc" id="L269">            jobStatsManager = new JobStatsManager(</span>
                configManager, 
                playerJobDAO, 
                jobManager, 
                jobLevelRewardManager
            );
            
            // JobBlockPermissionManagerの初期化
<span class="nc" id="L277">            jobBlockPermissionManager = new org.tofu.tofunomics.jobs.JobBlockPermissionManager(</span>
                configManager,
                jobManager
            );
            
<span class="nc" id="L282">            getLogger().info(&quot;Phase 3 職業特化機能を初期化しました&quot;);</span>
<span class="nc" id="L283">        } catch (Exception e) {</span>
<span class="nc" id="L284">            getLogger().severe(&quot;Phase 3 マネージャー初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L285">            e.printStackTrace();</span>
<span class="nc" id="L286">        }</span>
<span class="nc" id="L287">    }</span>
    
    private void initializePhase4TradeSystem() {
        try {
<span class="nc bnc" id="L291" title="All 2 branches missed.">            if (!configManager.isTradeSystemEnabled()) {</span>
<span class="nc" id="L292">                getLogger().info(&quot;取引システムは無効化されています。&quot;);</span>
<span class="nc" id="L293">                return;</span>
            }
            
            // TradeChestManagerの初期化
<span class="nc" id="L297">            tradeChestManager = new org.tofu.tofunomics.trade.TradeChestManager(</span>
<span class="nc" id="L298">                databaseManager.getConnection(),</span>
                configManager,
                playerDAO
            );
            
            // TradePriceManagerの初期化
<span class="nc" id="L304">            tradePriceManager = new org.tofu.tofunomics.trade.TradePriceManager(</span>
                configManager,
                jobManager
            );
            
            // TradeChestListenerの初期化
<span class="nc" id="L310">            tradeChestListener = new org.tofu.tofunomics.trade.TradeChestListener(</span>
                tradeChestManager,
                tradePriceManager,
                configManager,
                playerDAO,
                jobManager
            );
            
<span class="nc" id="L318">            getLogger().info(&quot;Phase 4 取引システムを初期化しました&quot;);</span>
<span class="nc" id="L319">        } catch (Exception e) {</span>
<span class="nc" id="L320">            getLogger().severe(&quot;Phase 4 取引システム初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L321">            e.printStackTrace();</span>
<span class="nc" id="L322">        }</span>
        
        // Phase 6 クラフト制限システムの初期化
        try {
<span class="nc" id="L326">            getLogger().info(&quot;Phase 6 クラフト制限システム初期化開始&quot;);</span>
            
            // JobCraftPermissionManagerの初期化
<span class="nc" id="L329">            jobCraftPermissionManager = new org.tofu.tofunomics.jobs.JobCraftPermissionManager(</span>
                this,
                jobManager,
                configManager
            );
            
            // クラフト制限メッセージの強制初期化（緊急対応）
<span class="nc" id="L336">            getLogger().info(&quot;クラフト制限メッセージの強制初期化を実行&quot;);</span>
<span class="nc" id="L337">            configManager.ensureCraftRestrictionMessagesExist();</span>
<span class="nc" id="L338">            saveConfig(); // 設定を確実に保存</span>
<span class="nc" id="L339">            configManager.reloadConfig(); // リロードで反映</span>
            
            // CraftRestrictionEventHandlerの初期化（緊急対応）
<span class="nc" id="L342">            craftRestrictionEventHandler = new org.tofu.tofunomics.events.CraftRestrictionEventHandler(this);</span>
            
<span class="nc" id="L344">            getLogger().info(&quot;Phase 6 クラフト制限システムを初期化しました&quot;);</span>
<span class="nc" id="L345">        } catch (Exception e) {</span>
<span class="nc" id="L346">            getLogger().severe(&quot;Phase 6 クラフト制限システム初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L347">            e.printStackTrace();</span>
<span class="nc" id="L348">        }</span>
<span class="nc" id="L349">    }</span>
    
    /**
     * 設定の自動初期化処理
     */
    private void initializeAutoConfig() {
        try {
<span class="nc" id="L356">            getLogger().info(&quot;=== 設定自動初期化開始 ===&quot;);</span>
            
            // 新しい自動更新機能（バージョン2.0対応）
<span class="nc" id="L359">            getLogger().info(&quot;設定ファイルの自動更新を実行中...&quot;);</span>
<span class="nc" id="L360">            configManager.updateConfigWithDefaults();</span>
            
            // NPC関連設定の自動初期化
<span class="nc" id="L363">            configManager.ensureNPCMessagesExist();</span>
            
            // player_join設定の自動初期化
<span class="nc" id="L366">            configManager.ensurePlayerJoinSettingsExist();</span>
            
            // クラフト制限設定の自動初期化
<span class="nc" id="L369">            configManager.ensureCraftRestrictionMessagesExist();</span>
            
            // 設定を保存
<span class="nc" id="L372">            saveConfig();</span>
            
<span class="nc" id="L374">            getLogger().info(&quot;=== 設定自動初期化完了 ===&quot;);</span>
            
<span class="nc" id="L376">        } catch (Exception e) {</span>
<span class="nc" id="L377">            getLogger().severe(&quot;設定自動初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L378">            e.printStackTrace();</span>
<span class="nc" id="L379">        }</span>
<span class="nc" id="L380">    }</span>
    
    private void initializePhase5EventSystem() {
        try {
<span class="nc bnc" id="L384" title="All 2 branches missed.">            if (!configManager.isEventSystemEnabled()) {</span>
<span class="nc" id="L385">                getLogger().info(&quot;統合イベントシステムは無効化されています。&quot;);</span>
<span class="nc" id="L386">                return;</span>
            }
            
            // UnifiedEventHandlerの初期化
<span class="nc" id="L390">            getLogger().info(&quot;UnifiedEventHandler初期化開始&quot;);</span>
            try {
<span class="nc" id="L392">                unifiedEventHandler = new org.tofu.tofunomics.events.UnifiedEventHandler(</span>
                    this,
                    configManager,
                    playerDAO,
                    playerJobDAO,
                    jobManager,
                    jobExperienceManager,
                    jobIncomeManager,
                    jobQuestManager,
                    jobBlockPermissionManager
                );
<span class="nc" id="L403">                getLogger().info(&quot;UnifiedEventHandler初期化完了&quot;);</span>
<span class="nc" id="L404">            } catch (Exception e) {</span>
<span class="nc" id="L405">                getLogger().severe(&quot;UnifiedEventHandler初期化エラー: &quot; + e.getMessage());</span>
<span class="nc" id="L406">                e.printStackTrace();</span>
<span class="nc" id="L407">            }</span>
            
<span class="nc" id="L409">            getLogger().info(&quot;Phase 5 統合イベントシステムを初期化しました&quot;);</span>
<span class="nc" id="L410">        } catch (Exception e) {</span>
<span class="nc" id="L411">            getLogger().severe(&quot;Phase 5 統合イベントシステム初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L412">            e.printStackTrace();</span>
<span class="nc" id="L413">        }</span>
<span class="nc" id="L414">    }</span>
    
    private void initializePlayerJoinHandler() {
        try {
            // PlayerJoinHandlerの初期化
<span class="nc" id="L419">            playerJoinHandler = new org.tofu.tofunomics.players.PlayerJoinHandler(</span>
                this,
                configManager,
                playerDAO,
                scoreboardManager
            );
            
<span class="nc" id="L426">            getLogger().info(&quot;プレイヤー参加時処理を初期化しました&quot;);</span>
<span class="nc" id="L427">        } catch (Exception e) {</span>
<span class="nc" id="L428">            getLogger().severe(&quot;プレイヤー参加時処理の初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L429">            e.printStackTrace();</span>
<span class="nc" id="L430">        }</span>
<span class="nc" id="L431">    }</span>
    
    private void initializeScoreboardSystem() {
        try {
<span class="nc bnc" id="L435" title="All 2 branches missed.">            if (!configManager.isScoreboardEnabled()) {</span>
<span class="nc" id="L436">                getLogger().info(&quot;スコアボードシステムは無効化されています。&quot;);</span>
<span class="nc" id="L437">                return;</span>
            }
            
            // ScoreboardManagerの初期化
<span class="nc" id="L441">            scoreboardManager = new org.tofu.tofunomics.scoreboard.ScoreboardManager(</span>
                this,
                configManager,
                playerDAO,
                currencyConverter,
                jobManager
            );
            
<span class="nc" id="L449">            getLogger().info(&quot;スコアボードシステムを初期化しました&quot;);</span>
<span class="nc" id="L450">        } catch (Exception e) {</span>
<span class="nc" id="L451">            getLogger().severe(&quot;スコアボードシステムの初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L452">            e.printStackTrace();</span>
<span class="nc" id="L453">        }</span>
<span class="nc" id="L454">    }</span>
    
    private void registerEventListeners() {
        try {
            // Phase 5 統合イベントハンドラーの登録
<span class="nc bnc" id="L459" title="All 2 branches missed.">            if (unifiedEventHandler != null) {</span>
<span class="nc" id="L460">                getServer().getPluginManager().registerEvents(unifiedEventHandler, this);</span>
<span class="nc" id="L461">                getLogger().info(&quot;Phase 5 統合イベントハンドラーを登録しました&quot;);</span>
            } else {
                // フォールバック：既存の個別リスナーを登録
<span class="nc" id="L464">                getServer().getPluginManager().registerEvents(jobExperienceManager, this);</span>
<span class="nc" id="L465">                getServer().getPluginManager().registerEvents(jobIncomeManager, this);</span>
<span class="nc" id="L466">                getServer().getPluginManager().registerEvents(jobQuestManager, this);</span>
<span class="nc" id="L467">                getLogger().info(&quot;既存の個別イベントリスナーを登録しました&quot;);</span>
            }
            
            // Phase 4 取引システムイベントリスナーの登録
<span class="nc bnc" id="L471" title="All 2 branches missed.">            if (tradeChestListener != null) {</span>
<span class="nc" id="L472">                getServer().getPluginManager().registerEvents(tradeChestListener, this);</span>
<span class="nc" id="L473">                getLogger().info(&quot;取引システムリスナーを登録しました&quot;);</span>
            }
            
            // Phase 6 クラフト制限イベントハンドラーの登録（緊急対応）
<span class="nc bnc" id="L477" title="All 2 branches missed.">            if (craftRestrictionEventHandler != null) {</span>
<span class="nc" id="L478">                getServer().getPluginManager().registerEvents(craftRestrictionEventHandler, this);</span>
<span class="nc" id="L479">                getLogger().info(&quot;Phase 6 クラフト制限イベントハンドラーを登録しました&quot;);</span>
            }
            
            // プレイヤー参加時処理リスナーの登録
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (playerJoinHandler != null) {</span>
<span class="nc" id="L484">                getServer().getPluginManager().registerEvents(playerJoinHandler, this);</span>
<span class="nc" id="L485">                getLogger().info(&quot;プレイヤー参加時処理リスナーを登録しました&quot;);</span>
            }
            
            // スコアボードマネージャーリスナーの登録
<span class="nc bnc" id="L489" title="All 2 branches missed.">            if (scoreboardManager != null) {</span>
<span class="nc" id="L490">                getServer().getPluginManager().registerEvents(scoreboardManager, this);</span>
<span class="nc" id="L491">                getLogger().info(&quot;スコアボードシステムリスナーを登録しました&quot;);</span>
            }
            
            // NPCシステムリスナーの登録
<span class="nc" id="L495">            registerNPCEventListeners();</span>
            
<span class="nc" id="L497">            getLogger().info(&quot;全てのイベントリスナーを登録しました&quot;);</span>
<span class="nc" id="L498">        } catch (Exception e) {</span>
<span class="nc" id="L499">            getLogger().severe(&quot;イベントリスナー登録中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L500">            e.printStackTrace();</span>
<span class="nc" id="L501">        }</span>
<span class="nc" id="L502">    }</span>
    
    private void registerCommands() {
        try {
            // 経済系コマンド
<span class="nc" id="L507">            getCommand(&quot;balance&quot;).setExecutor(new BalanceCommand(configManager, currencyConverter));</span>
<span class="nc" id="L508">            getCommand(&quot;pay&quot;).setExecutor(new PayCommand(configManager, currencyConverter));</span>
<span class="nc" id="L509">            getCommand(&quot;withdraw&quot;).setExecutor(new WithdrawCommand(configManager, currencyConverter, bankLocationManager));</span>
<span class="nc" id="L510">            getCommand(&quot;deposit&quot;).setExecutor(new DepositCommand(configManager, currencyConverter, itemManager, bankLocationManager));</span>
<span class="nc" id="L511">            getCommand(&quot;balancetop&quot;).setExecutor(new BalanceTopCommand(configManager, currencyConverter, playerDAO));</span>
<span class="nc" id="L512">            getCommand(&quot;eco&quot;).setExecutor(new EcoCommand(configManager, currencyConverter, playerDAO));</span>
            
            // 職業系コマンド
<span class="nc" id="L515">            getCommand(&quot;jobs&quot;).setExecutor(new JobsCommand(configManager, jobManager, experienceManager));</span>
<span class="nc" id="L516">            getCommand(&quot;jobstats&quot;).setExecutor(new JobStatsCommand(jobStatsManager));</span>
<span class="nc" id="L517">            getCommand(&quot;quest&quot;).setExecutor(new JobQuestCommand(configManager, jobQuestManager));</span>
            
            // Phase 4 取引系コマンド
<span class="nc bnc" id="L520" title="All 2 branches missed.">            if (tradingNPCManager != null) {</span>
<span class="nc" id="L521">                org.tofu.tofunomics.commands.TradeCommand tradeCommand = </span>
                    new org.tofu.tofunomics.commands.TradeCommand(tradingNPCManager, configManager, tradeChestManager);
<span class="nc" id="L523">                getCommand(&quot;trade&quot;).setExecutor(tradeCommand);</span>
<span class="nc" id="L524">                getCommand(&quot;trade&quot;).setTabCompleter(tradeCommand);</span>
            }
            
            // スコアボード系コマンド
<span class="nc bnc" id="L528" title="All 2 branches missed.">            if (scoreboardManager != null) {</span>
<span class="nc" id="L529">                getCommand(&quot;scoreboard&quot;).setExecutor(</span>
                    new org.tofu.tofunomics.commands.ScoreboardCommand(scoreboardManager, configManager));
            }
            
            // メインコマンド（NPC管理機能含む）
<span class="nc bnc" id="L534" title="All 2 branches missed.">            if (npcManager != null) {</span>
<span class="nc" id="L535">                org.tofu.tofunomics.commands.TofuNomicsCommand mainCommand = </span>
                    new org.tofu.tofunomics.commands.TofuNomicsCommand(this, configManager, npcManager, bankNPCManager, tradingNPCManager, foodNPCManager);
<span class="nc" id="L537">                getCommand(&quot;tofunomics&quot;).setExecutor(mainCommand);</span>
<span class="nc" id="L538">                getCommand(&quot;tofunomics&quot;).setTabCompleter(mainCommand);</span>
            }
            
<span class="nc" id="L541">            getLogger().info(&quot;コマンドハンドラーを登録しました&quot;);</span>
<span class="nc" id="L542">        } catch (Exception e) {</span>
<span class="nc" id="L543">            getLogger().severe(&quot;コマンド登録中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L544">            e.printStackTrace();</span>
<span class="nc" id="L545">        }</span>
<span class="nc" id="L546">    }</span>
    
    // Getter methods for other classes to access
    public static TofuNomics getInstance() {
<span class="fc" id="L550">        return instance;</span>
    }
    
    public DatabaseManager getDatabaseManager() {
<span class="nc" id="L554">        return databaseManager;</span>
    }
    
    public PlayerDAO getPlayerDAO() {
<span class="nc" id="L558">        return playerDAO;</span>
    }
    
    public JobDAO getJobDAO() {
<span class="nc" id="L562">        return jobDAO;</span>
    }
    
    public PlayerJobDAO getPlayerJobDAO() {
<span class="nc" id="L566">        return playerJobDAO;</span>
    }
    
    public JobChangeDAO getJobChangeDAO() {
<span class="nc" id="L570">        return jobChangeDAO;</span>
    }
    
    public ConfigManager getConfigManager() {
<span class="nc" id="L574">        return configManager;</span>
    }
    
    public ItemManager getItemManager() {
<span class="nc" id="L578">        return itemManager;</span>
    }
    
    public CurrencyConverter getCurrencyConverter() {
<span class="nc" id="L582">        return currencyConverter;</span>
    }
    
    public BankLocationManager getBankLocationManager() {
<span class="nc" id="L586">        return bankLocationManager;</span>
    }
    
    public JobManager getJobManager() {
<span class="nc" id="L590">        return jobManager;</span>
    }
    
    public ExperienceManager getExperienceManager() {
<span class="nc" id="L594">        return experienceManager;</span>
    }
    
    public org.tofu.tofunomics.scoreboard.ScoreboardManager getScoreboardManager() {
<span class="nc" id="L598">        return scoreboardManager;</span>
    }
    
    // NPCシステムの初期化
    private void initializeNPCSystem() {
        try {
<span class="nc bnc" id="L604" title="All 2 branches missed.">            if (!configManager.isNPCSystemEnabled()) {</span>
<span class="nc" id="L605">                getLogger().info(&quot;NPCシステムは無効化されています&quot;);</span>
<span class="nc" id="L606">                return;</span>
            }
            
            // NPCマネージャーの初期化
<span class="nc" id="L610">            npcManager = new org.tofu.tofunomics.npc.NPCManager(this, configManager);</span>
            
            // GUIの初期化（NPCマネージャーより先に）
<span class="nc" id="L613">            bankGUI = new org.tofu.tofunomics.npc.gui.BankGUI(</span>
                this, 
                configManager, 
                currencyConverter, 
                itemManager
            );
            
            // 銀行NPCマネージャーの初期化
<span class="nc" id="L621">            bankNPCManager = new org.tofu.tofunomics.npc.BankNPCManager(</span>
                this, 
                configManager, 
                npcManager, 
                bankLocationManager, 
                currencyConverter,
                bankGUI
            );
            
            // 取引NPCマネージャーの初期化
<span class="nc" id="L631">            tradingNPCManager = new org.tofu.tofunomics.npc.TradingNPCManager(</span>
                this, 
                configManager, 
                npcManager, 
                currencyConverter, 
                jobManager, 
                tradePriceManager, 
                playerDAO
            );
            
            // 食料NPCマネージャーの初期化
<span class="nc" id="L642">            foodNPCManager = new org.tofu.tofunomics.npc.FoodNPCManager(</span>
                this,
                configManager,
                npcManager,
                currencyConverter,
                playerDAO
            );
            
            // NPCリスナーの初期化
<span class="nc" id="L651">            npcListener = new org.tofu.tofunomics.npc.NPCListener(</span>
                this, 
                configManager, 
                npcManager, 
                bankNPCManager, 
                tradingNPCManager,
                foodNPCManager
            );
            
<span class="nc" id="L660">            getLogger().info(&quot;TradingGUIインスタンス作成開始...&quot;);</span>
<span class="nc" id="L661">            tradingGUI = new org.tofu.tofunomics.npc.gui.TradingGUI(</span>
                this, 
                configManager, 
                currencyConverter, 
                jobManager, 
                tradingNPCManager, 
                tradePriceManager
            );
<span class="nc bnc" id="L669" title="All 2 branches missed.">            getLogger().info(&quot;TradingGUIインスタンス作成完了: &quot; + (tradingGUI != null ? &quot;成功&quot; : &quot;失敗&quot;));</span>
            
            // FoodGUIの初期化
<span class="nc" id="L672">            getLogger().info(&quot;FoodGUIインスタンス作成開始...&quot;);</span>
<span class="nc" id="L673">            foodGUI = new org.tofu.tofunomics.npc.gui.FoodGUI(</span>
                this, 
                configManager, 
                currencyConverter, 
                foodNPCManager
            );
<span class="nc bnc" id="L679" title="All 2 branches missed.">            getLogger().info(&quot;FoodGUIインスタンス作成完了: &quot; + (foodGUI != null ? &quot;成功&quot; : &quot;失敗&quot;));</span>
            
            // 既存のシステムNPCを削除（重複防止）
<span class="nc" id="L682">            npcManager.removeExistingSystemNPCs();</span>
            
            // NPCの生成
<span class="nc" id="L685">            npcManager.spawnConfiguredNPCs();</span>
<span class="nc" id="L686">            bankNPCManager.initializeBankNPCs();</span>
<span class="nc" id="L687">            tradingNPCManager.initializeTradingNPCs();</span>
            
            // 食料NPCマネージャーの初期化
<span class="nc" id="L690">            foodNPCManager.initializeFoodNPCs();</span>
            
<span class="nc" id="L692">            getLogger().info(&quot;NPCシステムを初期化しました&quot;);</span>
<span class="nc" id="L693">        } catch (Exception e) {</span>
<span class="nc" id="L694">            getLogger().severe(&quot;NPCシステムの初期化中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L695">            e.printStackTrace();</span>
<span class="nc" id="L696">        }</span>
<span class="nc" id="L697">    }</span>
    
    // NPCシステムのクリーンアップ
    private void cleanupNPCSystem() {
        try {
<span class="nc bnc" id="L702" title="All 2 branches missed.">            if (bankGUI != null) {</span>
<span class="nc" id="L703">                bankGUI.closeAllGUIs();</span>
            }
            
<span class="nc bnc" id="L706" title="All 2 branches missed.">            if (tradingGUI != null) {</span>
<span class="nc" id="L707">                tradingGUI.closeAllGUIs();</span>
            }
            
<span class="nc bnc" id="L710" title="All 2 branches missed.">            if (foodGUI != null) {</span>
<span class="nc" id="L711">                foodGUI.closeAllGUIs();</span>
            }
            
<span class="nc bnc" id="L714" title="All 2 branches missed.">            if (npcManager != null) {</span>
<span class="nc" id="L715">                npcManager.removeAllNPCs();</span>
            }
            
<span class="nc" id="L718">            getLogger().info(&quot;NPCシステムをクリーンアップしました&quot;);</span>
<span class="nc" id="L719">        } catch (Exception e) {</span>
<span class="nc" id="L720">            getLogger().warning(&quot;NPCシステムのクリーンアップ中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L721">        }</span>
<span class="nc" id="L722">    }</span>
    
    // NPCシステムのイベントリスナーを登録
    private void registerNPCEventListeners() {
<span class="nc bnc" id="L726" title="All 2 branches missed.">        if (npcListener != null) {</span>
<span class="nc" id="L727">            getServer().getPluginManager().registerEvents(npcListener, this);</span>
<span class="nc" id="L728">            getLogger().info(&quot;NPCイベントリスナーを登録しました&quot;);</span>
        }
        
<span class="nc bnc" id="L731" title="All 2 branches missed.">        if (bankGUI != null) {</span>
<span class="nc" id="L732">            getServer().getPluginManager().registerEvents(bankGUI, this);</span>
<span class="nc" id="L733">            getLogger().info(&quot;銀行GUIリスナーを登録しました&quot;);</span>
        }
        
<span class="nc bnc" id="L736" title="All 2 branches missed.">        if (tradingGUI != null) {</span>
<span class="nc" id="L737">            getServer().getPluginManager().registerEvents(tradingGUI, this);</span>
<span class="nc" id="L738">            getLogger().info(&quot;取引GUIリスナーを登録しました&quot;);</span>
        }
        
<span class="nc bnc" id="L741" title="All 2 branches missed.">        if (foodGUI != null) {</span>
<span class="nc" id="L742">            getServer().getPluginManager().registerEvents(foodGUI, this);</span>
<span class="nc" id="L743">            getLogger().info(&quot;食料GUIリスナーを登録しました&quot;);</span>
        }
<span class="nc" id="L745">    }</span>
    
    // NPCシステムのGetter メソッド
    public org.tofu.tofunomics.npc.NPCManager getNPCManager() {
<span class="nc" id="L749">        return npcManager;</span>
    }
    
    public org.tofu.tofunomics.npc.BankNPCManager getBankNPCManager() {
<span class="nc" id="L753">        return bankNPCManager;</span>
    }
    
    public org.tofu.tofunomics.npc.TradingNPCManager getTradingNPCManager() {
<span class="nc" id="L757">        return tradingNPCManager;</span>
    }
    
    public org.tofu.tofunomics.npc.FoodNPCManager getFoodNPCManager() {
<span class="nc" id="L761">        return foodNPCManager;</span>
    }
    
    public org.tofu.tofunomics.npc.gui.BankGUI getBankGUI() {
<span class="nc" id="L765">        return bankGUI;</span>
    }
    
    public org.tofu.tofunomics.npc.gui.TradingGUI getTradingGUI() {
<span class="nc bnc" id="L769" title="All 2 branches missed.">        getLogger().info(&quot;TradingGUIインスタンス取得要求: &quot; + (tradingGUI != null ? &quot;存在&quot; : &quot;null&quot;));</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">        if (tradingGUI == null) {</span>
<span class="nc" id="L771">            getLogger().warning(&quot;TradingGUIがnullです。初期化に問題がある可能性があります。&quot;);</span>
        }
<span class="nc" id="L773">        return tradingGUI;</span>
    }
    
    public org.tofu.tofunomics.npc.gui.FoodGUI getFoodGUI() {
<span class="nc" id="L777">        return foodGUI;</span>
    }
    
    // Phase 6 クラフト制限システムGetter
    public org.tofu.tofunomics.jobs.JobCraftPermissionManager getJobCraftPermissionManager() {
<span class="nc" id="L782">        return jobCraftPermissionManager;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>