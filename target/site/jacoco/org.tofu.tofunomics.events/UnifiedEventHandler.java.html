<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UnifiedEventHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TofuNomics</a> &gt; <a href="index.source.html" class="el_package">org.tofu.tofunomics.events</a> &gt; <span class="el_source">UnifiedEventHandler.java</span></div><h1>UnifiedEventHandler.java</h1><pre class="source lang-java linenums">package org.tofu.tofunomics.events;

import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.event.Event;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockBreakEvent;
import org.bukkit.event.block.BlockGrowEvent;
import org.bukkit.event.block.BlockPlaceEvent;
import org.bukkit.event.enchantment.EnchantItemEvent;
import org.bukkit.event.entity.EntityBreedEvent;
import org.bukkit.event.entity.EntityDeathEvent;
import org.bukkit.event.inventory.BrewEvent;
import org.bukkit.event.inventory.CraftItemEvent;
import org.bukkit.event.player.PlayerFishEvent;
import org.bukkit.plugin.java.JavaPlugin;
import org.tofu.tofunomics.config.ConfigManager;
import org.tofu.tofunomics.dao.PlayerDAO;
import org.tofu.tofunomics.dao.PlayerJobDAO;
import java.util.List;
import org.tofu.tofunomics.models.PlayerJob;
import org.tofu.tofunomics.TofuNomics;
import org.tofu.tofunomics.jobs.JobManager;

import java.util.logging.Logger;

/**
 * 統合イベントハンドラシステム
 * 全てのゲームプレイイベントを一元管理し、パフォーマンスを最適化
 */
public class UnifiedEventHandler implements Listener {
    
    private final JavaPlugin plugin;
    private final ConfigManager configManager;
    private final PlayerDAO playerDAO;
    private final PlayerJobDAO playerJobDAO;
    private final JobManager jobManager;
    private final Logger logger;
    
    // サブシステム
    private final EventCache eventCache;
    private final EventProcessor eventProcessor;
    private final AsyncEventUpdater asyncUpdater;
    
    // 個別イベントハンドラ
    private final org.tofu.tofunomics.events.handlers.BrewingEventHandler brewingHandler;
    private final org.tofu.tofunomics.events.handlers.EnchantmentEventHandler enchantmentHandler;
    private final org.tofu.tofunomics.events.handlers.BreedingEventHandler breedingHandler;
    private final org.tofu.tofunomics.events.handlers.GrowthEventHandler growthHandler;
    private final org.tofu.tofunomics.events.handlers.BuildingEventHandler buildingHandler;
    
    // 既存のハンドラ参照
    private final org.tofu.tofunomics.experience.JobExperienceManager experienceManager;
    private final org.tofu.tofunomics.income.JobIncomeManager incomeManager;
    private final org.tofu.tofunomics.quests.JobQuestManager questManager;
    
    // 職業ブロック制限システム
    private final org.tofu.tofunomics.jobs.JobBlockPermissionManager blockPermissionManager;
    
    public UnifiedEventHandler(JavaPlugin plugin, ConfigManager configManager,
                              PlayerDAO playerDAO, PlayerJobDAO playerJobDAO,
                              JobManager jobManager,
                              org.tofu.tofunomics.experience.JobExperienceManager experienceManager,
                              org.tofu.tofunomics.income.JobIncomeManager incomeManager,
                              org.tofu.tofunomics.quests.JobQuestManager questManager,
<span class="nc" id="L68">                              org.tofu.tofunomics.jobs.JobBlockPermissionManager blockPermissionManager) {</span>
<span class="nc" id="L69">        this.plugin = plugin;</span>
<span class="nc" id="L70">        this.configManager = configManager;</span>
<span class="nc" id="L71">        this.playerDAO = playerDAO;</span>
<span class="nc" id="L72">        this.playerJobDAO = playerJobDAO;</span>
<span class="nc" id="L73">        this.jobManager = jobManager;</span>
<span class="nc" id="L74">        this.logger = plugin.getLogger();</span>
<span class="nc" id="L75">        this.experienceManager = experienceManager;</span>
<span class="nc" id="L76">        this.incomeManager = incomeManager;</span>
<span class="nc" id="L77">        this.questManager = questManager;</span>
<span class="nc" id="L78">        this.blockPermissionManager = blockPermissionManager;</span>
        
        // サブシステムの初期化
<span class="nc" id="L81">        this.eventCache = new EventCache(plugin);</span>
<span class="nc" id="L82">        this.eventProcessor = new EventProcessor(configManager, jobManager);</span>
<span class="nc" id="L83">        this.asyncUpdater = new AsyncEventUpdater(plugin, playerDAO, playerJobDAO);</span>
        
        // 個別ハンドラの初期化
<span class="nc" id="L86">        this.brewingHandler = new org.tofu.tofunomics.events.handlers.BrewingEventHandler(</span>
            configManager, playerDAO, jobManager, asyncUpdater
        );
<span class="nc" id="L89">        this.enchantmentHandler = new org.tofu.tofunomics.events.handlers.EnchantmentEventHandler(</span>
            configManager, playerDAO, jobManager, asyncUpdater
        );
<span class="nc" id="L92">        this.breedingHandler = new org.tofu.tofunomics.events.handlers.BreedingEventHandler(</span>
            configManager, playerDAO, jobManager, asyncUpdater
        );
<span class="nc" id="L95">        this.growthHandler = new org.tofu.tofunomics.events.handlers.GrowthEventHandler(</span>
            configManager, playerDAO, jobManager, asyncUpdater
        );
<span class="nc" id="L98">        this.buildingHandler = new org.tofu.tofunomics.events.handlers.BuildingEventHandler(</span>
            configManager, playerDAO, jobManager, asyncUpdater
        );
<span class="nc" id="L101">    }</span>
    
    // ========== ブロック関連イベント ==========
    
    @EventHandler(priority = EventPriority.HIGH, ignoreCancelled = true)
    public void onBlockBreak(BlockBreakEvent event) {
<span class="nc" id="L107">        System.out.println(&quot;=== UnifiedEventHandler.onBlockBreak デバッグ開始 ===&quot;);</span>
<span class="nc" id="L108">        System.out.println(&quot;イベント: &quot; + event.getClass().getSimpleName());</span>
        
        // 基本的なイベント処理チェック
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (!shouldProcessEvent(event)) {</span>
<span class="nc" id="L112">            System.out.println(&quot;shouldProcessEventでfalse、処理をスキップ&quot;);</span>
<span class="nc" id="L113">            return;</span>
        }
        
<span class="nc" id="L116">        Player player = event.getPlayer();</span>
<span class="nc" id="L117">        Material blockType = event.getBlock().getType();</span>
        
<span class="nc" id="L119">        System.out.println(&quot;プレイヤー: &quot; + player.getName());</span>
<span class="nc" id="L120">        System.out.println(&quot;ブロック: &quot; + blockType.name());</span>
        
        // 無職プレイヤーの専門ブロック制限チェック（フェールセーフ）
<span class="nc" id="L123">        List&lt;PlayerJob&gt; playerJobs = jobManager.getPlayerJobs(player);</span>
<span class="nc bnc" id="L124" title="All 4 branches missed.">        boolean hasAnyJob = playerJobs != null &amp;&amp; !playerJobs.isEmpty();</span>
        
<span class="nc bnc" id="L126" title="All 2 branches missed.">        System.out.println(&quot;職業の保有状況: &quot; + (hasAnyJob ? &quot;職業あり（&quot; + playerJobs.size() + &quot;個）&quot; : &quot;無職&quot;));</span>
        
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (!hasAnyJob) {</span>
            // 無職プレイヤーの場合、専門ブロックは即座に拒否
<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (!blockPermissionManager.getBasicBlocks().contains(blockType)) {</span>
<span class="nc" id="L131">                System.out.println(&quot;無職プレイヤーが専門ブロックを破壊しようとしました - 拒否&quot;);</span>
<span class="nc" id="L132">                event.setCancelled(true);</span>
<span class="nc" id="L133">                player.sendMessage(&quot;§c職業に就いていないため、このブロックは破壊できません。&quot;);</span>
<span class="nc" id="L134">                player.sendMessage(&quot;§7/jobs join &lt;職業名&gt; で職業に就職してください。&quot;);</span>
<span class="nc" id="L135">                return;</span>
            } else {
<span class="nc" id="L137">                System.out.println(&quot;無職プレイヤーが基本ブロックを破壊 - 許可&quot;);</span>
            }
        }
        
        // 職業ブロック制限チェック（優先度HIGHで早期チェック）
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!blockPermissionManager.canPlayerBreakBlock(player, blockType)) {</span>
<span class="nc" id="L143">            System.out.println(&quot;blockPermissionManagerで拒否されました&quot;);</span>
<span class="nc" id="L144">            event.setCancelled(true);</span>
<span class="nc" id="L145">            String message = blockPermissionManager.getDeniedMessage(player, blockType);</span>
<span class="nc" id="L146">            player.sendMessage(message);</span>
<span class="nc" id="L147">            return;</span>
        }
        
<span class="nc" id="L150">        System.out.println(&quot;ブロック破壊許可 - 通常処理を継続&quot;);</span>
        
        // キャッシュチェック
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (eventCache.isRecentlyProcessed(player, &quot;block_break&quot;, 50)) {</span>
<span class="nc" id="L154">            System.out.println(&quot;重複イベントのためスキップ&quot;);</span>
<span class="nc" id="L155">            return; // 50ms以内の重複イベントは無視</span>
        }
        
        // 既存のマネージャーに処理を委譲
<span class="nc" id="L159">        experienceManager.onBlockBreak(event);</span>
<span class="nc" id="L160">        incomeManager.onBlockBreak(event);</span>
<span class="nc" id="L161">        questManager.onBlockBreak(event);</span>
        
        // キャッシュに記録
<span class="nc" id="L164">        eventCache.markAsProcessed(player, &quot;block_break&quot;);</span>
        
<span class="nc" id="L166">        System.out.println(&quot;=== ブロック破壊イベント処理完了 ===&quot;);</span>
<span class="nc" id="L167">    }</span>
    
    @EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
    public void onBlockPlace(BlockPlaceEvent event) {
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (!shouldProcessEvent(event)) return;</span>
        
<span class="nc" id="L173">        Player player = event.getPlayer();</span>
        
        // キャッシュチェック
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (eventCache.isRecentlyProcessed(player, &quot;block_place&quot;, 50)) {</span>
<span class="nc" id="L177">            return;</span>
        }
        
        // 建築家専用処理
<span class="nc" id="L181">        buildingHandler.handleBlockPlace(event);</span>
        
        // キャッシュに記録
<span class="nc" id="L184">        eventCache.markAsProcessed(player, &quot;block_place&quot;);</span>
<span class="nc" id="L185">    }</span>
    
    @EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
    public void onBlockGrow(BlockGrowEvent event) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (!shouldProcessEvent(event)) return;</span>
        
        // 農家の作物成長処理
<span class="nc" id="L192">        growthHandler.handleBlockGrow(event);</span>
<span class="nc" id="L193">    }</span>
    
    // ========== クラフト・醸造・エンチャント関連イベント ==========
    
    @EventHandler(priority = EventPriority.HIGH, ignoreCancelled = true)
    public void onCraftItem(CraftItemEvent event) {
<span class="nc" id="L199">        plugin.getLogger().info(&quot;=== onCraftItem メソッド開始 ===&quot;);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (!shouldProcessEvent(event)) return;</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (!(event.getWhoClicked() instanceof Player)) return;</span>
        
<span class="nc" id="L203">        Player player = (Player) event.getWhoClicked();</span>
<span class="nc" id="L204">        Material craftedItem = event.getRecipe().getResult().getType();</span>
        
        // クラフト制限チェック（優先度HIGH で先にチェック）
<span class="nc" id="L207">        TofuNomics tofuPlugin = (TofuNomics) plugin;</span>
<span class="nc" id="L208">        plugin.getLogger().info(&quot;=== CraftItemEvent処理開始 ===&quot;);</span>
<span class="nc" id="L209">        plugin.getLogger().info(&quot;プレイヤー: &quot; + player.getName() + &quot;, アイテム: &quot; + craftedItem.name());</span>
        
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (tofuPlugin.getJobCraftPermissionManager() != null) {</span>
<span class="nc" id="L212">            plugin.getLogger().info(&quot;JobCraftPermissionManager: 初期化済み&quot;);</span>
            
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (!tofuPlugin.getJobCraftPermissionManager().canPlayerCraftItem(player, craftedItem)) {</span>
                // クラフトを禁止
<span class="nc" id="L216">                event.setCancelled(true);</span>
                
                // 制限メッセージを送信
<span class="nc" id="L219">                String message = tofuPlugin.getJobCraftPermissionManager().getCraftDeniedMessage(player, craftedItem);</span>
<span class="nc" id="L220">                player.sendMessage(message);</span>
                
<span class="nc" id="L222">                plugin.getLogger().info(&quot;クラフト制限: &quot; + player.getName() + &quot; が &quot; + craftedItem.name() + &quot; のクラフトを禁止されました&quot;);</span>
<span class="nc" id="L223">                return;</span>
            } else {
<span class="nc" id="L225">                plugin.getLogger().info(&quot;クラフト許可: &quot; + player.getName() + &quot; が &quot; + craftedItem.name() + &quot; のクラフトを許可&quot;);</span>
            }
        } else {
<span class="nc" id="L228">            plugin.getLogger().warning(&quot;JobCraftPermissionManager: 未初期化のため制限チェックをスキップ&quot;);</span>
        }
        
        // キャッシュチェック
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (eventCache.isRecentlyProcessed(player, &quot;craft_item&quot;, 100)) {</span>
<span class="nc" id="L233">            return;</span>
        }
        
        // 既存のマネージャーに処理を委譲
<span class="nc" id="L237">        experienceManager.onCraftItem(event);</span>
<span class="nc" id="L238">        incomeManager.onCraftItem(event);</span>
<span class="nc" id="L239">        questManager.onCraftItem(event);</span>
        
        // キャッシュに記録
<span class="nc" id="L242">        eventCache.markAsProcessed(player, &quot;craft_item&quot;);</span>
<span class="nc" id="L243">    }</span>
    
    @EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
    public void onBrew(BrewEvent event) {
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (!shouldProcessEvent(event)) return;</span>
        
        // 調合師専用処理
<span class="nc" id="L250">        brewingHandler.handleBrew(event);</span>
<span class="nc" id="L251">    }</span>
    
    @EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
    public void onEnchantItem(EnchantItemEvent event) {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (!shouldProcessEvent(event)) return;</span>
        
<span class="nc" id="L257">        Player player = event.getEnchanter();</span>
        
        // キャッシュチェック
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (eventCache.isRecentlyProcessed(player, &quot;enchant_item&quot;, 500)) {</span>
<span class="nc" id="L261">            return;</span>
        }
        
        // 既存のマネージャーに処理を委譲
<span class="nc" id="L265">        experienceManager.onEnchantItem(event);</span>
        
        // 魔術師専用処理
<span class="nc" id="L268">        enchantmentHandler.handleEnchantment(event);</span>
        
        // キャッシュに記録
<span class="nc" id="L271">        eventCache.markAsProcessed(player, &quot;enchant_item&quot;);</span>
<span class="nc" id="L272">    }</span>
    
    // ========== エンティティ関連イベント ==========
    
    @EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
    public void onEntityDeath(EntityDeathEvent event) {
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (!shouldProcessEvent(event)) return;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (event.getEntity().getKiller() == null) return;</span>
        
<span class="nc" id="L281">        Player player = event.getEntity().getKiller();</span>
        
        // キャッシュチェック
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (eventCache.isRecentlyProcessed(player, &quot;entity_death&quot;, 100)) {</span>
<span class="nc" id="L285">            return;</span>
        }
        
        // エンティティ討伐による基本的な報酬処理（将来実装）
        // handleEntityDeathRewards(event, player);
        
        // キャッシュに記録
<span class="nc" id="L292">        eventCache.markAsProcessed(player, &quot;entity_death&quot;);</span>
<span class="nc" id="L293">    }</span>
    
    @EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
    public void onEntityBreed(EntityBreedEvent event) {
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (!shouldProcessEvent(event)) return;</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (!(event.getBreeder() instanceof Player)) return;</span>
        
<span class="nc" id="L300">        Player player = (Player) event.getBreeder();</span>
        
        // キャッシュチェック
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (eventCache.isRecentlyProcessed(player, &quot;entity_breed&quot;, 1000)) {</span>
<span class="nc" id="L304">            return;</span>
        }
        
        // 農家専用処理
<span class="nc" id="L308">        breedingHandler.handleBreeding(event);</span>
        
        // キャッシュに記録
<span class="nc" id="L311">        eventCache.markAsProcessed(player, &quot;entity_breed&quot;);</span>
<span class="nc" id="L312">    }</span>
    
    // ========== プレイヤーアクション関連イベント ==========
    
    @EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
    public void onPlayerFish(PlayerFishEvent event) {
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (!shouldProcessEvent(event)) return;</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (event.getState() != PlayerFishEvent.State.CAUGHT_FISH) return;</span>
        
<span class="nc" id="L321">        Player player = event.getPlayer();</span>
        
        // キャッシュチェック
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (eventCache.isRecentlyProcessed(player, &quot;player_fish&quot;, 500)) {</span>
<span class="nc" id="L325">            return;</span>
        }
        
        // 既存のマネージャーに処理を委譲
<span class="nc" id="L329">        experienceManager.onPlayerFish(event);</span>
<span class="nc" id="L330">        incomeManager.onPlayerFish(event);</span>
<span class="nc" id="L331">        questManager.onPlayerFish(event);</span>
        
        // キャッシュに記録
<span class="nc" id="L334">        eventCache.markAsProcessed(player, &quot;player_fish&quot;);</span>
<span class="nc" id="L335">    }</span>
    
    // ========== ユーティリティメソッド ==========
    
    /**
     * イベント処理を行うべきかチェック
     */
    private boolean shouldProcessEvent(Event event) {
<span class="nc" id="L343">        plugin.getLogger().info(&quot;=== shouldProcessEvent 診断開始 ===&quot;);</span>
<span class="nc" id="L344">        plugin.getLogger().info(&quot;イベントタイプ: &quot; + event.getClass().getSimpleName());</span>
        
        // 設定でイベントシステムが無効化されている場合
<span class="nc" id="L347">        boolean isEventSystemEnabled = configManager.isEventSystemEnabled();</span>
<span class="nc" id="L348">        plugin.getLogger().info(&quot;イベントシステム有効: &quot; + isEventSystemEnabled);</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">        if (!isEventSystemEnabled) {</span>
<span class="nc" id="L350">            plugin.getLogger().info(&quot;判定結果: イベントシステムが無効のため処理スキップ&quot;);</span>
<span class="nc" id="L351">            return false;</span>
        }
        
        // イベント処理プロセッサでの判定
<span class="nc" id="L355">        boolean shouldProcessByProcessor = eventProcessor.shouldProcessEvent(event);</span>
<span class="nc" id="L356">        plugin.getLogger().info(&quot;イベントプロセッサ判定: &quot; + shouldProcessByProcessor);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (!shouldProcessByProcessor) {</span>
<span class="nc" id="L358">            plugin.getLogger().info(&quot;判定結果: イベントプロセッサが処理を拒否&quot;);</span>
<span class="nc" id="L359">            return false;</span>
        }
        
<span class="nc" id="L362">        plugin.getLogger().info(&quot;判定結果: イベント処理を実行&quot;);</span>
<span class="nc" id="L363">        return true;</span>
    }
    
    /**
     * システムのクリーンアップ
     */
    public void cleanup() {
<span class="nc" id="L370">        eventCache.cleanup();</span>
<span class="nc" id="L371">        asyncUpdater.shutdown();</span>
<span class="nc" id="L372">        logger.info(&quot;UnifiedEventHandler cleaned up successfully&quot;);</span>
<span class="nc" id="L373">    }</span>
    
    /**
     * 統計情報の取得
     */
    public EventStatistics getStatistics() {
<span class="nc" id="L379">        return new EventStatistics(</span>
<span class="nc" id="L380">            eventCache.getTotalProcessedEvents(),</span>
<span class="nc" id="L381">            eventCache.getCacheHitRate(),</span>
<span class="nc" id="L382">            asyncUpdater.getPendingUpdates()</span>
        );
    }
    
    /**
     * エンティティ討伐による報酬処理
     */
    private void handleEntityDeathRewards(EntityDeathEvent event, Player player) {
<span class="nc bnc" id="L390" title="All 4 branches missed.">        if (event.getEntity() == null || player == null) {</span>
<span class="nc" id="L391">            return;</span>
        }
        
        // プレイヤーの職業を取得
<span class="nc" id="L395">        List&lt;org.tofu.tofunomics.models.PlayerJob&gt; playerJobs = jobManager.getPlayerJobs(player);</span>
<span class="nc bnc" id="L396" title="All 4 branches missed.">        if (playerJobs == null || playerJobs.isEmpty()) {</span>
<span class="nc" id="L397">            return; // 無職の場合は報酬なし</span>
        }
        
<span class="nc" id="L400">        org.tofu.tofunomics.models.PlayerJob primaryJob = playerJobs.get(0);</span>
        // JobIDから職業名を取得
<span class="nc" id="L402">        org.tofu.tofunomics.models.Job job = jobManager.getJobById(primaryJob.getJobId());</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (job == null) {</span>
<span class="nc" id="L404">            return; // 有効な職業が見つからない場合は処理しない</span>
        }
<span class="nc" id="L406">        String jobName = job.getName();</span>
<span class="nc" id="L407">        int jobLevel = primaryJob.getLevel();</span>
        
        // エンティティタイプに応じた基本経験値と報酬を設定
<span class="nc" id="L410">        double baseExperience = getBaseExperienceForEntity(event.getEntity());</span>
<span class="nc" id="L411">        double baseIncome = getBaseIncomeForEntity(event.getEntity());</span>
        
<span class="nc bnc" id="L413" title="All 4 branches missed.">        if (baseExperience &gt; 0 || baseIncome &gt; 0) {</span>
            // レベル補正を適用
<span class="nc" id="L415">            double levelMultiplier = 1.0 + (jobLevel * 0.01); // レベル1毎に1%増加</span>
            
<span class="nc" id="L417">            double finalExperience = baseExperience * levelMultiplier;</span>
<span class="nc" id="L418">            double finalIncome = baseIncome * levelMultiplier;</span>
            
            // 経験値付与（既存システムを利用）
<span class="nc bnc" id="L421" title="All 2 branches missed.">            if (finalExperience &gt; 0) {</span>
<span class="nc" id="L422">                experienceManager.giveExperienceManual(player, jobName, finalExperience);</span>
            }
            
            // 収入付与（既存システムを利用）
<span class="nc bnc" id="L426" title="All 2 branches missed.">            if (finalIncome &gt; 0) {</span>
<span class="nc" id="L427">                incomeManager.giveIncomeManual(player, jobName, finalIncome);</span>
                
                // プレイヤーに通知
<span class="nc" id="L430">                player.sendMessage(String.format(&quot;§7[%s] §e+%.1f経験値 §a+%.2f金塊&quot;, </span>
<span class="nc" id="L431">                    configManager.getJobDisplayName(jobName), finalExperience, finalIncome));</span>
            }
        }
<span class="nc" id="L434">    }</span>
    
    /**
     * エンティティタイプに応じた基本経験値を取得
     */
    private double getBaseExperienceForEntity(org.bukkit.entity.Entity entity) {
<span class="nc bnc" id="L440" title="All 7 branches missed.">        switch (entity.getType()) {</span>
            // 敵対的モブ
            case ZOMBIE:
            case SKELETON:
            case SPIDER:
            case CREEPER:
<span class="nc" id="L446">                return 2.0;</span>
            case ENDERMAN:
            case WITCH:
<span class="nc" id="L449">                return 5.0;</span>
            case BLAZE:
            case GHAST:
<span class="nc" id="L452">                return 8.0;</span>
            // ボス系
            case ENDER_DRAGON:
<span class="nc" id="L455">                return 100.0;</span>
            case WITHER:
<span class="nc" id="L457">                return 80.0;</span>
            // 動物（農家の畜産業）
            case COW:
            case PIG:
            case CHICKEN:
            case SHEEP:
<span class="nc" id="L463">                return 1.0;</span>
            default:
<span class="nc" id="L465">                return 0.0;</span>
        }
    }
    
    /**
     * エンティティタイプに応じた基本収入を取得
     */
    private double getBaseIncomeForEntity(org.bukkit.entity.Entity entity) {
<span class="nc bnc" id="L473" title="All 7 branches missed.">        switch (entity.getType()) {</span>
            // 敵対的モブ
            case ZOMBIE:
            case SKELETON:
            case SPIDER:
            case CREEPER:
<span class="nc" id="L479">                return 1.5;</span>
            case ENDERMAN:
            case WITCH:
<span class="nc" id="L482">                return 3.0;</span>
            case BLAZE:
            case GHAST:
<span class="nc" id="L485">                return 5.0;</span>
            // ボス系
            case ENDER_DRAGON:
<span class="nc" id="L488">                return 500.0;</span>
            case WITHER:
<span class="nc" id="L490">                return 300.0;</span>
            // 動物（農家の畜産業）
            case COW:
            case PIG:
            case CHICKEN:
            case SHEEP:
<span class="nc" id="L496">                return 0.8;</span>
            default:
<span class="nc" id="L498">                return 0.0;</span>
        }
    }
    
    /**
     * イベント統計クラス
     */
    public static class EventStatistics {
        private final long totalProcessedEvents;
        private final double cacheHitRate;
        private final int pendingUpdates;
        
<span class="nc" id="L510">        public EventStatistics(long totalProcessedEvents, double cacheHitRate, int pendingUpdates) {</span>
<span class="nc" id="L511">            this.totalProcessedEvents = totalProcessedEvents;</span>
<span class="nc" id="L512">            this.cacheHitRate = cacheHitRate;</span>
<span class="nc" id="L513">            this.pendingUpdates = pendingUpdates;</span>
<span class="nc" id="L514">        }</span>
        
<span class="nc" id="L516">        public long getTotalProcessedEvents() { return totalProcessedEvents; }</span>
<span class="nc" id="L517">        public double getCacheHitRate() { return cacheHitRate; }</span>
<span class="nc" id="L518">        public int getPendingUpdates() { return pendingUpdates; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>