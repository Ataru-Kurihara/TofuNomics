<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NPCManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TofuNomics</a> &gt; <a href="index.source.html" class="el_package">org.tofu.tofunomics.npc</a> &gt; <span class="el_source">NPCManager.java</span></div><h1>NPCManager.java</h1><pre class="source lang-java linenums">package org.tofu.tofunomics.npc;

import org.bukkit.Location;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;
import org.bukkit.entity.Villager;
import org.bukkit.inventory.MerchantRecipe;
import org.tofu.tofunomics.config.ConfigManager;
import org.tofu.tofunomics.TofuNomics;

import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class NPCManager {
    
    private final TofuNomics plugin;
    private final ConfigManager configManager;
<span class="nc" id="L18">    private final Map&lt;UUID, NPCData&gt; npcs = new ConcurrentHashMap&lt;&gt;();</span>
    
<span class="nc" id="L20">    public NPCManager(TofuNomics plugin, ConfigManager configManager) {</span>
<span class="nc" id="L21">        this.plugin = plugin;</span>
<span class="nc" id="L22">        this.configManager = configManager;</span>
<span class="nc" id="L23">    }</span>
    
    public static class NPCData {
        private final UUID entityId;
        private final String npcType;
        private final String name;
        private final Location location;
        private final Villager entity;
        
<span class="nc" id="L32">        public NPCData(UUID entityId, String npcType, String name, Location location, Villager entity) {</span>
<span class="nc" id="L33">            this.entityId = entityId;</span>
<span class="nc" id="L34">            this.npcType = npcType;</span>
<span class="nc" id="L35">            this.name = name;</span>
<span class="nc" id="L36">            this.location = location;</span>
<span class="nc" id="L37">            this.entity = entity;</span>
<span class="nc" id="L38">        }</span>
        
<span class="nc" id="L40">        public UUID getEntityId() { return entityId; }</span>
<span class="nc" id="L41">        public String getNpcType() { return npcType; }</span>
<span class="nc" id="L42">        public String getName() { return name; }</span>
<span class="nc" id="L43">        public Location getLocation() { return location; }</span>
<span class="nc" id="L44">        public Villager getEntity() { return entity; }</span>
    }
    
    public Villager createNPC(Location location, String npcType, String name) {
<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (location.getWorld() == null) {</span>
<span class="nc" id="L49">            plugin.getLogger().warning(&quot;NPCの生成に失敗: ワールドが無効です - &quot; + location);</span>
<span class="nc" id="L50">            return null;</span>
        }
        
        try {
<span class="nc" id="L54">            Villager villager = (Villager) location.getWorld().spawnEntity(location, EntityType.VILLAGER);</span>
            
            // NPC設定
<span class="nc" id="L57">            villager.setCustomName(name);</span>
<span class="nc" id="L58">            villager.setCustomNameVisible(true);</span>
<span class="nc" id="L59">            villager.setProfession(getNPCProfession(npcType));</span>
<span class="nc" id="L60">            villager.setVillagerType(Villager.Type.PLAINS);</span>
<span class="nc" id="L61">            villager.setAI(false);</span>
<span class="nc" id="L62">            villager.setSilent(true);</span>
<span class="nc" id="L63">            villager.setInvulnerable(true);</span>
<span class="nc" id="L64">            villager.setRemoveWhenFarAway(false);</span>
            
            // システムNPC識別用のメタデータを設定
<span class="nc" id="L67">            villager.setMetadata(&quot;tofunomics_system_npc&quot;, new org.bukkit.metadata.FixedMetadataValue(plugin, true));</span>
<span class="nc" id="L68">            villager.setMetadata(&quot;tofunomics_npc_type&quot;, new org.bukkit.metadata.FixedMetadataValue(plugin, npcType));</span>
<span class="nc" id="L69">            villager.setMetadata(&quot;tofunomics_creation_time&quot;, new org.bukkit.metadata.FixedMetadataValue(plugin, System.currentTimeMillis()));</span>
            
            // 取引を無効化
<span class="nc" id="L72">            villager.setRecipes(new ArrayList&lt;&gt;());</span>
            
            // NPCデータを保存
<span class="nc" id="L75">            NPCData npcData = new NPCData(villager.getUniqueId(), npcType, name, location, villager);</span>
<span class="nc" id="L76">            npcs.put(villager.getUniqueId(), npcData);</span>
            
<span class="nc" id="L78">            plugin.getLogger().info(&quot;NPCを生成しました: &quot; + name + &quot; (&quot; + npcType + &quot;) at &quot; + </span>
<span class="nc" id="L79">                location.getX() + &quot;, &quot; + location.getY() + &quot;, &quot; + location.getZ());</span>
            
<span class="nc" id="L81">            return villager;</span>
<span class="nc" id="L82">        } catch (Exception e) {</span>
<span class="nc" id="L83">            plugin.getLogger().severe(&quot;NPC生成中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L84">            e.printStackTrace();</span>
<span class="nc" id="L85">            return null;</span>
        }
    }
    
    private Villager.Profession getNPCProfession(String npcType) {
<span class="nc bnc" id="L90" title="All 5 branches missed.">        switch (npcType.toLowerCase()) {</span>
            case &quot;banker&quot;:
<span class="nc" id="L92">                return Villager.Profession.LIBRARIAN;</span>
            case &quot;trader&quot;:
<span class="nc" id="L94">                return Villager.Profession.WEAPONSMITH;</span>
            case &quot;merchant&quot;:
<span class="nc" id="L96">                return Villager.Profession.TOOLSMITH;</span>
            case &quot;food_merchant&quot;:
<span class="nc" id="L98">                return Villager.Profession.BUTCHER;</span>
            default:
<span class="nc" id="L100">                return Villager.Profession.NITWIT;</span>
        }
    }
    
    public boolean removeNPC(UUID npcId) {
<span class="nc" id="L105">        NPCData npcData = npcs.get(npcId);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (npcData != null) {</span>
            try {
<span class="nc" id="L108">                npcData.getEntity().remove();</span>
<span class="nc" id="L109">                npcs.remove(npcId);</span>
<span class="nc" id="L110">                plugin.getLogger().info(&quot;NPCを削除しました: &quot; + npcData.getName());</span>
<span class="nc" id="L111">                return true;</span>
<span class="nc" id="L112">            } catch (Exception e) {</span>
<span class="nc" id="L113">                plugin.getLogger().warning(&quot;NPC削除中にエラーが発生しました: &quot; + e.getMessage());</span>
            }
        }
<span class="nc" id="L116">        return false;</span>
    }
    
    public NPCData getNPCData(UUID entityId) {
<span class="nc" id="L120">        return npcs.get(entityId);</span>
    }
    
    public Collection&lt;NPCData&gt; getAllNPCs() {
<span class="nc" id="L124">        return npcs.values();</span>
    }
    
    public Collection&lt;NPCData&gt; getNPCsByType(String npcType) {
<span class="nc" id="L128">        return npcs.values().stream()</span>
<span class="nc" id="L129">            .filter(npcData -&gt; npcData.getNpcType().equals(npcType))</span>
<span class="nc" id="L130">            .collect(ArrayList::new, (list, npc) -&gt; list.add(npc), ArrayList::addAll);</span>
    }
    
    public boolean isNPCEntity(UUID entityId) {
<span class="nc" id="L134">        return npcs.containsKey(entityId);</span>
    }
    
    public void removeAllNPCs() {
<span class="nc bnc" id="L138" title="All 2 branches missed.">        for (NPCData npcData : npcs.values()) {</span>
            try {
<span class="nc" id="L140">                npcData.getEntity().remove();</span>
<span class="nc" id="L141">            } catch (Exception e) {</span>
<span class="nc" id="L142">                plugin.getLogger().warning(&quot;NPC削除中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L143">            }</span>
<span class="nc" id="L144">        }</span>
<span class="nc" id="L145">        npcs.clear();</span>
<span class="nc" id="L146">        plugin.getLogger().info(&quot;全てのNPCを削除しました&quot;);</span>
<span class="nc" id="L147">    }</span>
    
    /**
     * ワールド内の既存システムNPCを削除する
     * プラグイン再起動時の重複NPC問題を解決
     */
    public void removeExistingSystemNPCs() {
<span class="nc" id="L154">        int removedCount = 0;</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        for (org.bukkit.World world : plugin.getServer().getWorlds()) {</span>
            try {
<span class="nc bnc" id="L157" title="All 2 branches missed.">                for (org.bukkit.entity.Entity entity : world.getEntitiesByClass(org.bukkit.entity.Villager.class)) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                    if (isSystemNPC(entity)) {</span>
<span class="nc" id="L159">                        plugin.getLogger().info(&quot;既存システムNPCを削除: &quot; + entity.getCustomName() + &quot; at &quot; + </span>
<span class="nc" id="L160">                            entity.getLocation().getX() + &quot;, &quot; + entity.getLocation().getY() + &quot;, &quot; + entity.getLocation().getZ());</span>
<span class="nc" id="L161">                        entity.remove();</span>
<span class="nc" id="L162">                        removedCount++;</span>
                    }
<span class="nc" id="L164">                }</span>
<span class="nc" id="L165">            } catch (Exception e) {</span>
<span class="nc" id="L166">                plugin.getLogger().warning(&quot;ワールド &quot; + world.getName() + &quot; でのNPC削除中にエラー: &quot; + e.getMessage());</span>
<span class="nc" id="L167">            }</span>
<span class="nc" id="L168">        }</span>
        
        // 内部データもクリア
<span class="nc" id="L171">        npcs.clear();</span>
        
<span class="nc" id="L173">        plugin.getLogger().info(&quot;既存システムNPCを &quot; + removedCount + &quot; 個削除しました&quot;);</span>
<span class="nc" id="L174">    }</span>
    
    /**
     * エンティティがシステム作成のNPCかどうかを判定
     */
    public boolean isSystemNPC(org.bukkit.entity.Entity entity) {
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (!(entity instanceof org.bukkit.entity.Villager)) {</span>
<span class="nc" id="L181">            return false;</span>
        }
        
        // メタデータでの判定
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (entity.hasMetadata(&quot;tofunomics_system_npc&quot;)) {</span>
<span class="nc" id="L186">            return entity.getMetadata(&quot;tofunomics_system_npc&quot;).get(0).asBoolean();</span>
        }
        
        // カスタムネームでの判定（フォールバック）
<span class="nc" id="L190">        String customName = entity.getCustomName();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (customName != null) {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            return customName.contains(&quot;銀行員&quot;) || </span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                   customName.contains(&quot;中央市場&quot;) || </span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                   customName.contains(&quot;鉱夫取引所&quot;) || </span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                   customName.contains(&quot;木材市場&quot;) || </span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                   customName.contains(&quot;農産物市場&quot;) || </span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                   customName.contains(&quot;漁港&quot;) ||</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">                   customName.contains(&quot;ATM&quot;);</span>
        }
        
<span class="nc" id="L201">        return false;</span>
    }
    
    public void spawnConfiguredNPCs() {
        try {
            // 銀行NPCの生成
<span class="nc" id="L207">            List&lt;Map&lt;?, ?&gt;&gt; bankNPCs = configManager.getBankNPCs();</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            for (Map&lt;?, ?&gt; npcConfig : bankNPCs) {</span>
<span class="nc" id="L209">                spawnNPCFromConfig(npcConfig, &quot;banker&quot;);</span>
<span class="nc" id="L210">            }</span>
            
            // 取引NPCの生成
<span class="nc" id="L213">            List&lt;Map&lt;?, ?&gt;&gt; tradeNPCs = configManager.getTradingPostConfigs();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            for (Map&lt;?, ?&gt; npcConfig : tradeNPCs) {</span>
<span class="nc" id="L215">                spawnNPCFromConfig(npcConfig, &quot;trader&quot;);</span>
<span class="nc" id="L216">            }</span>
            
<span class="nc" id="L218">            plugin.getLogger().info(&quot;設定ファイルからNPCを生成しました&quot;);</span>
<span class="nc" id="L219">        } catch (Exception e) {</span>
<span class="nc" id="L220">            plugin.getLogger().severe(&quot;設定ファイルからのNPC生成中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L221">            e.printStackTrace();</span>
<span class="nc" id="L222">        }</span>
<span class="nc" id="L223">    }</span>
    
    private void spawnNPCFromConfig(Map&lt;?, ?&gt; npcConfig, String npcType) {
        try {
<span class="nc" id="L227">            String world = (String) npcConfig.get(&quot;world&quot;);</span>
<span class="nc" id="L228">            int x = (Integer) npcConfig.get(&quot;x&quot;);</span>
<span class="nc" id="L229">            int y = (Integer) npcConfig.get(&quot;y&quot;);</span>
<span class="nc" id="L230">            int z = (Integer) npcConfig.get(&quot;z&quot;);</span>
<span class="nc" id="L231">            String name = (String) npcConfig.get(&quot;name&quot;);</span>
            
<span class="nc bnc" id="L233" title="All 4 branches missed.">            if (world == null || name == null) {</span>
<span class="nc" id="L234">                plugin.getLogger().warning(&quot;NPC設定が不完全です: &quot; + npcConfig);</span>
<span class="nc" id="L235">                return;</span>
            }
            
            // 削除フラグをチェック
<span class="nc" id="L239">            Object deletedObj = npcConfig.get(&quot;deleted&quot;);</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">            boolean isDeleted = deletedObj != null &amp;&amp; (Boolean) deletedObj;</span>
            
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (isDeleted) {</span>
<span class="nc" id="L243">                plugin.getLogger().info(&quot;削除済みNPCのためスポーンをスキップ: &quot; + name + &quot; (&quot; + npcType + &quot;)&quot;);</span>
<span class="nc" id="L244">                return;</span>
            }
            
<span class="nc" id="L247">            Location location = new Location(plugin.getServer().getWorld(world), x + 0.5, y, z + 0.5);</span>
<span class="nc" id="L248">            createNPC(location, npcType, name);</span>
            
<span class="nc" id="L250">        } catch (Exception e) {</span>
<span class="nc" id="L251">            plugin.getLogger().warning(&quot;NPC生成中にエラーが発生しました: &quot; + e.getMessage());</span>
<span class="nc" id="L252">        }</span>
<span class="nc" id="L253">    }</span>
    
    public double getDistanceToNearestNPC(Player player, String npcType) {
<span class="nc" id="L256">        Location playerLocation = player.getLocation();</span>
<span class="nc" id="L257">        double minDistance = Double.MAX_VALUE;</span>
        
<span class="nc bnc" id="L259" title="All 2 branches missed.">        for (NPCData npcData : getNPCsByType(npcType)) {</span>
<span class="nc" id="L260">            Location npcLocation = npcData.getLocation();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (npcLocation.getWorld().equals(playerLocation.getWorld())) {</span>
<span class="nc" id="L262">                double distance = playerLocation.distance(npcLocation);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (distance &lt; minDistance) {</span>
<span class="nc" id="L264">                    minDistance = distance;</span>
                }
            }
<span class="nc" id="L267">        }</span>
        
<span class="nc" id="L269">        return minDistance;</span>
    }
    
    public NPCData getNearestNPC(Player player, String npcType) {
<span class="nc" id="L273">        Location playerLocation = player.getLocation();</span>
<span class="nc" id="L274">        NPCData nearest = null;</span>
<span class="nc" id="L275">        double minDistance = Double.MAX_VALUE;</span>
        
<span class="nc bnc" id="L277" title="All 2 branches missed.">        for (NPCData npcData : getNPCsByType(npcType)) {</span>
<span class="nc" id="L278">            Location npcLocation = npcData.getLocation();</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            if (npcLocation.getWorld().equals(playerLocation.getWorld())) {</span>
<span class="nc" id="L280">                double distance = playerLocation.distance(npcLocation);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">                if (distance &lt; minDistance) {</span>
<span class="nc" id="L282">                    minDistance = distance;</span>
<span class="nc" id="L283">                    nearest = npcData;</span>
                }
            }
<span class="nc" id="L286">        }</span>
        
<span class="nc" id="L288">        return nearest;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>