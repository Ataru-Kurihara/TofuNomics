# 都市保護と賃貸物件保護の両立ガイド

## 概要

このガイドでは、TofuNomicsワールド全体（都市）のブロック破壊・設置を防ぎつつ、賃貸物件内では契約者のみが自由に活動できるようにする設定方法を説明します。

### 目的

- **都市全体の保護**: 一般プレイヤーによる無秩序なブロック破壊・設置を防止
- **賃貸物件の自由度**: 契約者は賃貸物件内でのみドアの開閉、ブロック設置などが可能
- **管理の効率化**: WorldGuardの親子リージョン機能を活用した一元管理

### メリット

✅ 都市景観の保護
✅ 賃貸システムの機能を損なわない
✅ 1つの親リージョンで都市全体を管理
✅ 新規物件は自動的に保護設定が適用

---

## 仕組みの説明

### WorldGuard親子リージョン構造

```
┌─────────────────────────────────────┐
│  親リージョン: city_protection      │
│  (都市全体)                          │
│  - BUILD: DENY (破壊・設置禁止)      │
│  - USE: DENY (ドア・ボタン使用禁止)  │
│                                      │
│  ┌──────────────────┐               │
│  │ 子リージョン:    │               │
│  │ housing_1        │               │
│  │ メンバー: 契約者  │               │
│  │ → 物件内のみ操作可│               │
│  └──────────────────┘               │
│                                      │
│  ┌──────────────────┐               │
│  │ 子リージョン:    │               │
│  │ housing_2        │               │
│  │ メンバー: 契約者  │               │
│  │ → 物件内のみ操作可│               │
│  └──────────────────┘               │
└─────────────────────────────────────┘
```

### 権限の優先順位

1. **子リージョン（賃貸物件）のメンバー権限が最優先**
   - 賃貸契約者は物件内で全ての操作が可能
   - 契約終了時に自動的にメンバーから削除

2. **親リージョン（都市全体）の制限が適用**
   - 非契約者は都市全体で何もできない
   - 賃貸物件外では契約者も制限される

---

## 前提条件

### 必要なプラグイン

- **WorldGuard** (7.0.0以降)
- **TofuNomics** (最新版)

### 必要な権限

以下のいずれかの権限が必要です：

- `tofunomics.housing.admin` - 住居管理権限
- `tofunomics.admin` - 管理者権限
- サーバーOP権限

### 動作確認済み環境

- Minecraft 1.16.5
- Paper/Spigot サーバー
- WorldGuard 7.0.7

---

## 設定手順

### ステップ1: 都市保護リージョンの作成

#### 1.1 範囲選択

木の斧を手に持ち、都市全体を覆う範囲を選択します。

```
左クリック: 第1座標を設定（最小座標）
右クリック: 第2座標を設定（最大座標）
```

**例**: 座標 (-500, 0, -500) から (500, 256, 500) まで選択

#### 1.2 都市保護リージョン作成コマンド実行

```bash
/housing admin createcityregion city_protection
```

**実行結果**:
```
§aWorldGuardリージョン 'city_protection' を作成しました
§aBUILDフラグとUSEフラグをDENYに設定しました
§7次に '/housing admin setparent city_protection' で既存物件を子リージョンに設定してください
```

#### 1.3 作成されたリージョンの確認

```bash
/rg info city_protection
```

以下のフラグが設定されていることを確認：
- `build: deny`
- `use: deny`

---

### ステップ2: config.ymlの編集

プラグインのconfig.ymlファイルを編集します。

**ファイルパス**: `plugins/TofuNomics/config.yml`

```yaml
housing_rental:
  # ... 既存の設定 ...

  # 都市保護設定
  city_protection:
    # 都市保護の有効化
    enabled: true
    # 親リージョン名（ステップ1で作成したリージョン名）
    region_name: "city_protection"
    # 対象ワールド
    world_name: "tofuNomics"
```

**設定パラメータ説明**:

| パラメータ | 説明 | デフォルト値 |
|----------|------|------------|
| `enabled` | 都市保護システムの有効/無効 | `false` |
| `region_name` | 親リージョン名 | `""` (空) |
| `world_name` | 対象ワールド名 | `"tofuNomics"` |

---

### ステップ3: 既存物件の親子関係設定

既に登録されている賃貸物件がある場合、以下のコマンドで一括設定します。

```bash
/housing admin setparent city_protection
```

**実行結果**:
```
§a親リージョン設定完了
§7成功: 5 件
§7スキップ: 2 件 (WorldGuardリージョン未設定またはエラー)
```

**注意**:
- WorldGuardリージョンが設定されていない物件はスキップされます
- 既存の賃貸契約には影響しません（契約者は引き続き物件内で操作可能）

---

### ステップ4: プラグインリロード

設定を反映させるためにプラグインをリロードします。

```bash
/reload confirm
```

または、サーバーを再起動してください。

**⚠️ 警告**: リロードではなくサーバー再起動を推奨します（安全性のため）

---

## コマンドリファレンス

### `/housing admin createcityregion <リージョン名>`

都市保護用の親リージョンを作成します。

**権限**: `tofunomics.housing.admin`

**使用例**:
```bash
/housing admin createcityregion city_protection
```

**処理内容**:
1. 選択された範囲にWorldGuardリージョンを作成
2. `build` フラグを `deny` に設定（ブロック破壊・設置禁止）
3. `use` フラグを `deny` に設定（ドア・ボタン・レバー使用禁止）

**エラー時の対処**:
- `§c範囲選択が完了していません` → 木の斧で範囲選択してください
- `§cWorldGuard統合が無効です` → WorldGuardプラグインを導入してください

---

### `/housing admin setparent <親リージョン名>`

全ての既存賃貸物件を指定した親リージョンの子に設定します。

**権限**: `tofunomics.housing.admin`

**使用例**:
```bash
/housing admin setparent city_protection
```

**処理内容**:
1. 全賃貸物件のリストを取得
2. WorldGuardリージョンが設定されている物件のみを対象
3. 各物件リージョンの親を指定リージョンに設定

**注意点**:
- config.ymlの `city_protection.region_name` と異なる名前を指定すると警告が表示されます
- WorldGuardリージョンが設定されていない物件は自動的にスキップされます

---

### `/housing admin register` (新規物件登録)

新規物件を登録する際、config.ymlで `city_protection.enabled: true` の場合、自動的に親リージョンの子として設定されます。

**使用例**:
```bash
/housing admin register 高級マンション 100 --wg housing_mansion_01
```

**自動処理**:
1. 物件データベースに登録
2. WorldGuardリージョン `housing_mansion_01` を作成
3. `city_protection` の子リージョンとして設定（自動）
4. 契約時に賃貸者がメンバーに追加される

---

## config.yml設定詳細

### 都市保護セクション

```yaml
housing_rental:
  city_protection:
    enabled: false      # 都市保護の有効化
    region_name: ""     # 親リージョン名
    world_name: "tofuNomics"  # 対象ワールド名
```

### 推奨設定

**本番環境（都市保護を使用する場合）**:
```yaml
city_protection:
  enabled: true
  region_name: "city_protection"
  world_name: "tofuNomics"
```

**テスト環境（都市保護なし）**:
```yaml
city_protection:
  enabled: false
  region_name: ""
  world_name: "tofuNomics"
```

---

## 動作確認方法

### 確認シナリオ1: 都市全体での操作制限

**テスト内容**: 一般プレイヤーが都市内でブロックを破壊・設置できないか確認

1. 一般プレイヤーでログイン（賃貸契約なし）
2. 都市内の任意の場所でブロックを破壊しようとする
3. 「この領域では破壊できません」というメッセージが表示されればOK

**期待される結果**:
```
§cこのブロックは保護されています
```

---

### 確認シナリオ2: 賃貸物件内での操作権限

**テスト内容**: 賃貸契約者が物件内でのみ操作できるか確認

1. プレイヤーAで物件を賃貸
   ```bash
   /housing rent 1 7
   ```

2. 物件内でブロックを設置・破壊できることを確認
3. 物件外（都市内）でブロックを設置・破壊できないことを確認
4. ドアの開閉が物件内でのみ可能であることを確認

**期待される結果**:
- 物件内: 全ての操作が可能 ✅
- 物件外: 全ての操作が不可 ❌

---

### 確認シナリオ3: 契約終了後の権限削除

**テスト内容**: 契約終了後に物件内での操作ができなくなるか確認

1. プレイヤーAで物件の契約をキャンセル
   ```bash
   /housing cancel 1
   ```

2. 物件内でブロックを設置・破壊できないことを確認
3. ドアの開閉ができないことを確認

**期待される結果**:
```
§cこのブロックは保護されています
```

---

## トラブルシューティング

### 問題1: 親リージョンが作成できない

**症状**: `/housing admin createcityregion` コマンドがエラーになる

**原因と対処法**:

| 原因 | 対処法 |
|------|--------|
| WorldGuardプラグイン未導入 | WorldGuard 7.0.0以降を導入 |
| 範囲選択が未完了 | 木の斧で2点を選択してから実行 |
| 同名のリージョンが既存 | `/rg remove <リージョン名>` で削除してから再作成 |

**ログ確認**:
```bash
tail -f logs/latest.log | grep WorldGuard
```

---

### 問題2: 既存物件が子リージョンにならない

**症状**: `/housing admin setparent` 実行後も親子関係が設定されない

**確認方法**:
```bash
/rg info <物件リージョン名>
```

**原因と対処法**:

| 原因 | 対処法 |
|------|--------|
| 物件にWorldGuardリージョンが未設定 | `--wg` オプション付きで物件を再登録 |
| 親リージョンが存在しない | ステップ1から再実行 |
| ワールド名が異なる | config.ymlの `world_name` を確認 |

**手動設定方法**:
```bash
/rg setparent <物件リージョン名> <親リージョン名>
```

---

### 問題3: 賃貸契約者も操作できない

**症状**: 契約者が物件内でブロックを設置・破壊できない

**確認方法**:
```bash
/rg info <物件リージョン名> -w <ワールド名>
```

**原因と対処法**:

| 原因 | 対処法 |
|------|--------|
| メンバーに追加されていない | データベースを確認し、手動でメンバー追加 |
| フラグが正しく設定されていない | `/rg flag <物件リージョン名> passthrough allow` を実行 |
| 親リージョンのフラグが強すぎる | 親リージョンの優先度を確認 |

**手動でメンバー追加**:
```bash
/rg addmember <物件リージョン名> <プレイヤー名>
```

---

### 問題4: config.ymlの設定が反映されない

**症状**: 新規物件が自動的に子リージョンにならない

**確認方法**:
1. config.ymlの `city_protection.enabled` が `true` か確認
2. `city_protection.region_name` が正しく設定されているか確認
3. サーバーログでエラーがないか確認

**対処法**:
1. config.ymlの構文エラーを確認（YAMLバリデーター使用）
2. プラグインをリロードまたはサーバー再起動
3. ログで警告メッセージを確認

---

## よくある質問（FAQ）

### Q1: 既存の賃貸契約に影響はありますか？

**A**: いいえ、影響ありません。既存の契約者は引き続き物件内で操作可能です。親子リージョン設定は権限を追加するものであり、既存の権限を削除するものではありません。

---

### Q2: 複数の親リージョンを設定できますか？

**A**: いいえ、1つのワールドに対して1つの親リージョンのみ設定できます。複数のエリアを保護したい場合は、より大きな親リージョンを作成するか、WorldGuardのリージョン優先度機能を活用してください。

---

### Q3: パフォーマンスへの影響はありますか？

**A**: WorldGuardの親子リージョン機能は最適化されており、パフォーマンスへの影響は最小限です。ただし、以下の点に注意してください：

- リージョン数が100を超える場合は定期的な最適化を推奨
- プレイヤー数が多い場合はWorldGuardの設定を調整

---

### Q4: 管理者も都市内で操作できなくなりますか？

**A**: いいえ、以下の権限を持つ管理者は制限を受けません：

- `worldguard.region.bypass.<ワールド名>`
- サーバーOP権限

権限設定例:
```yaml
permissions:
  admin:
    - worldguard.region.bypass.tofuNomics
```

---

### Q5: 都市保護を一時的に無効化できますか？

**A**: はい、config.ymlで `city_protection.enabled: false` に設定し、プラグインをリロードしてください。既存の親子関係は維持されますが、新規物件の自動設定は無効化されます。

**緊急時の完全無効化**:
```bash
/rg flag city_protection build allow
/rg flag city_protection use allow
```

---

### Q6: 他のプラグインとの競合はありますか？

**A**: WorldGuardと正しく統合されているプラグインであれば競合しません。以下のプラグインは動作確認済みです：

- LuckPerms
- GriefPrevention
- CoreProtect

---

## ロールバック方法

都市保護設定を元に戻す必要がある場合の手順：

### 方法1: config.ymlで無効化

```yaml
housing_rental:
  city_protection:
    enabled: false  # 無効化
```

その後、プラグインをリロード：
```bash
/reload confirm
```

---

### 方法2: 親子関係のみ解除

全物件の親リージョンを解除：

```bash
# 各物件リージョンに対して実行
/rg setparent <物件リージョン名>
```

**注意**: 親リージョン自体は削除されません

---

### 方法3: 完全削除

親リージョンを完全に削除：

```bash
/rg remove city_protection
```

**⚠️ 警告**: 削除後は都市全体が無防備になります

---

## 関連ドキュメント

- [住居賃貸システム管理ガイド](./housing-rental.md) - 賃貸システムの基本設定
- [WorldGuard公式ドキュメント](https://worldguard.enginehub.org/en/latest/) - リージョン管理の詳細
- [TofuNomics管理者ガイド](./admin-guide.md) - 総合管理ガイド

---

## サポート

問題が解決しない場合は、以下の情報を添えて管理者チームに問い合わせてください：

1. **サーバーログ** (`logs/latest.log`)
2. **config.yml** (関連部分)
3. **実行したコマンド**
4. **エラーメッセージ**
5. **WorldGuardバージョン**

---

## まとめ

都市保護と賃貸物件保護の両立は、WorldGuardの親子リージョン機能を活用することで実現できます。この設定により：

✅ 都市景観が保護される
✅ 賃貸システムが正常に機能する
✅ 管理が効率化される
✅ プレイヤー体験が向上する

適切な設定と定期的な動作確認により、安全で快適なサーバー環境を維持できます。
